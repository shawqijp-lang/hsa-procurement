<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
    
    <!-- Enhanced PWA Settings for Native App Appearance -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="HSA EVALUATE" />
    <meta name="application-name" content="HSA EVALUATE" />
    
    <!-- Theme and Colors -->
    <meta name="theme-color" content="#FFD700" />
    <meta name="msapplication-TileColor" content="#FFD700" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="msapplication-navbutton-color" content="#FFD700" />
    
    <!-- Disable Browser Features -->
    <meta name="msapplication-tap-highlight" content="no" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="HandheldFriendly" content="true" />
    <meta name="MobileOptimized" content="width" />
    <meta name="apple-touch-fullscreen" content="yes" />
    
    <!-- PWA manifest -->
    <link rel="manifest" href="/manifest.json" />
    
    <!-- Microsoft Edge specific configurations -->
    <meta name="msapplication-config" content="/browserconfig.xml" />
    
    <!-- Enhanced Edge PWA Integration -->
    <meta name="msapplication-square70x70logo" content="/icons/mstile-70x70.png" />
    <meta name="msapplication-square150x150logo" content="/icons/mstile-150x150.png" />
    <meta name="msapplication-wide310x150logo" content="/icons/mstile-310x150.png" />
    <meta name="msapplication-square310x310logo" content="/icons/mstile-310x310.png" />
    
    <!-- Edge Enhanced Features -->
    <meta name="application-name" content="HSA EVALUATE" />
    <meta name="msapplication-tooltip" content="نظام تقييم بيئة العمل المتطور" />
    <meta name="msapplication-task" content="name=التقييم السريع;action-uri=/evaluation;icon-uri=/icons/icon-192x192.png" />
    <meta name="msapplication-task" content="name=التقارير;action-uri=/reports;icon-uri=/icons/icon-192x192.png" />
    <meta name="msapplication-task" content="name=وضع عدم الاتصال;action-uri=/?offline=true;icon-uri=/icons/icon-192x192.png" />
    
    <!-- Hide Browser URL Bar -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-touch-startup-image" content="/icons/icon-512x512.png" />
    <meta name="msapplication-starturl" content="/" />
    <meta name="msapplication-window" content="width=1024;height=768" />
    
    <!-- Force Standalone Mode -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    
    <!-- Favicon and icons -->
    <link rel="icon" type="image/png" href="/icons/icon-192x192.png" />
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png" />
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    
    <!-- Arabic fonts -->
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    
    <title>HSA EVALUATE - نظام إدارة التنظيف</title>
    
    <!-- Meta tags for SEO -->
    <meta name="description" content="نظام إدارة التنظيف والصيانة للمرافق - HSA EVALUATE" />
    <meta name="keywords" content="تنظيف، صيانة، إدارة، تقييم، HSA" />
    
    <!-- Open Graph tags -->
    <meta property="og:title" content="HSA EVALUATE - نظام إدارة التنظيف" />
    <meta property="og:description" content="نظام إدارة التنظيف والصيانة للمرافق" />
    <meta property="og:type" content="website" />
    
    <!-- Enhanced CSS for Native App Appearance -->
    <style>
      :root {
        --safe-area-inset-top: env(safe-area-inset-top);
        --safe-area-inset-right: env(safe-area-inset-right);
        --safe-area-inset-bottom: env(safe-area-inset-bottom);
        --safe-area-inset-left: env(safe-area-inset-left);
      }
      
      /* Hide browser elements and make app look native */
      body {
        font-family: 'IBM Plex Sans Arabic', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        margin: 0;
        padding: 0;
        direction: rtl;
        overscroll-behavior: none;
        -webkit-overflow-scrolling: touch;
        -webkit-user-select: none;
        -webkit-tap-highlight-color: transparent;
      }
      
      /* Force fullscreen and hide browser UI */
      html, body {
        height: 100vh;
        overflow-x: hidden;
        -webkit-app-region: no-drag;
        -webkit-user-select: none;
        user-select: none;
        -webkit-touch-callout: none;
        -webkit-text-size-adjust: 100%;
        -ms-text-size-adjust: 100%;
      }
      
      /* Hide URL bar on mobile */
      @media screen and (max-width: 768px) {
        body {
          padding-top: env(safe-area-inset-top);
          padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* Force mobile app behavior */
        html {
          -webkit-text-size-adjust: none;
          -ms-text-size-adjust: none;
          text-size-adjust: none;
        }
      }
      
      /* Prevent context menu and selection */
      * {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }
      
      /* Allow text selection only in inputs */
      input, textarea, [contenteditable="true"] {
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        user-select: text;
      }
      
      /* Standalone app detection and styling */
      @media all and (display-mode: standalone) {
        body {
          background-color: #000000;
        }
        
        .app-container {
          padding-top: env(safe-area-inset-top);
          padding-bottom: env(safe-area-inset-bottom);
        }
      }
      
      /* iOS Safari specific fixes */
      @supports (-webkit-appearance: none) {
        body {
          -webkit-appearance: none;
          -webkit-overflow-scrolling: touch;
        }
      }
        background-color: #f9fafb;
        overscroll-behavior: none;
        touch-action: pan-x pan-y;
        -webkit-overflow-scrolling: touch;
      }
      
      /* Fullscreen support for PWA */
      @media (display-mode: fullscreen) {
        body {
          padding-top: var(--safe-area-inset-top);
          padding-right: var(--safe-area-inset-right);
          padding-bottom: var(--safe-area-inset-bottom);
          padding-left: var(--safe-area-inset-left);
        }
      }
      
      /* PWA specific optimizations */
      @media (display-mode: standalone) {
        html, body {
          user-select: none;
          -webkit-user-select: none;
          -webkit-touch-callout: none;
          -webkit-tap-highlight-color: transparent;
        }
        
        body {
          overflow-x: hidden;
          position: relative;
        }
      }
      
      /* Enhanced mobile experience */
      @media (max-width: 768px) {
        body {
          -webkit-text-size-adjust: 100%;
          -ms-text-size-adjust: 100%;
          text-size-adjust: 100%;
        }
      }
      
      /* Loading screen */
      .loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        color: #000;
      }
      
      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-right-color: #000;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 16px;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      .loading-text {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
      }
      
      .loading-subtitle {
        font-size: 14px;
        opacity: 0.8;
      }
      
      /* Enhanced mobile touch support for input fields */
      input, textarea, select {
        -webkit-tap-highlight-color: transparent !important;
        -webkit-touch-callout: none;
        -webkit-user-select: text !important;
        user-select: text !important;
        touch-action: manipulation;
        font-size: 16px !important; /* Prevents zoom on iOS */
      }
      
      /* Focus enhancement for mobile */
      input:focus, textarea:focus, select:focus {
        outline: none !important;
        box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.5) !important;
        border-color: #fbbf24 !important;
      }
      
      /* Ensure buttons are easily tappable */
      button, .btn, [role="button"] {
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
        min-height: 44px; /* iOS recommended touch target size */
        min-width: 44px;
      }
      
      /* Fix for iOS input zoom prevention */
      @media screen and (max-width: 768px) {
        input, textarea, select {
          font-size: 16px !important;
          transform: translateZ(0);
        }
      }
    </style>
  </head>
  <body>
    <div id="root">
      <!-- Loading screen while app initializes -->
      <div class="loading-screen" id="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">HSA Group</div>
        <div class="loading-subtitle">نظام إدارة بيئة العمل</div>
      </div>
      
      <!-- PWA install prompt prevention -->
    </div>
    
    <!-- Service Worker registration -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('/sw.js')
            .then(function(registration) {
              console.log('✅ Service Worker registered:', registration);
            })
            .catch(function(error) {
              console.log('❌ Service Worker registration failed:', error);
            });
        });
      }
    </script>
    
    <script type="module" src="/src/index.tsx"></script>
    
    <!-- Hide loading screen when React loads -->
    <script>
      // إزالة شاشة التحميل عند تحميل React
      const checkReactLoaded = () => {
        const root = document.getElementById('root');
        const loadingScreen = document.getElementById('loading-screen');
        
        if (root && root.children.length > 1 && loadingScreen) {
          console.log('✅ React loaded successfully - hiding loading screen');
          loadingScreen.style.opacity = '0';
          setTimeout(() => {
            if (loadingScreen.parentNode) {
              loadingScreen.remove();
            }
          }, 300);
        } else if (loadingScreen) {
          // إعادة المحاولة بعد قليل
          setTimeout(checkReactLoaded, 100);
        }
      };
      
      // بدء الفحص بعد تحميل DOM
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          setTimeout(checkReactLoaded, 500);
        });
      } else {
        setTimeout(checkReactLoaded, 500);
      }
      
      // إزالة قسرية بعد 5 ثوان
      setTimeout(() => {
        const loadingScreen = document.getElementById('loading-screen');
        if (loadingScreen) {
          console.log('⏰ Force removing loading screen after 5 seconds');
          loadingScreen.remove();
        }
      }, 5000);
    </script>
    
    <!-- Enhanced PWA registration and optimization -->
    <script>
      // تحسين PWA للعمل كتطبيق أصلي
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', async () => {
          try {
            const registration = await navigator.serviceWorker.register('/sw.js');
            console.log('✅ SW registered:', registration);
            
            // إخفاء شاشة التحميل بعد تسجيل SW
            setTimeout(() => {
              const loadingScreen = document.getElementById('loading-screen');
              if (loadingScreen && document.getElementById('root').children.length > 1) {
                loadingScreen.style.opacity = '0';
                setTimeout(() => loadingScreen.remove(), 300);
              }
            }, 2000);
            
          } catch (error) {
            console.error('❌ SW registration failed:', error);
            // إخفاء شاشة التحميل حتى لو فشل SW
            setTimeout(() => {
              const loadingScreen = document.getElementById('loading-screen');
              if (loadingScreen && document.getElementById('root').children.length > 1) {
                loadingScreen.remove();
              }
            }, 3000);
          }
        });
      }
      
      // منع إظهار banner تثبيت PWA الافتراضي وتحسين تجربة التثبيت
      let deferredPrompt;
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        console.log('PWA install prompt suppressed');
        
        // عرض زر تثبيت مخصص بدلاً من banner النظام
        showCustomInstallPrompt();
      });
      
      // دالة عرض زر التثبيت المخصص
      function showCustomInstallPrompt() {
        // فقط إذا لم يكن التطبيق مثبتاً مسبقاً
        if (window.matchMedia('(display-mode: standalone)').matches) {
          return; // التطبيق مثبت مسبقاً
        }
        
        // إنشاء زر تثبيت مخصص
        const installButton = document.createElement('div');
        installButton.innerHTML = `
          <div style="
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #fbbf24;
            color: #000;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            z-index: 1000;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            direction: rtl;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
          " onclick="installPWA()">
            📱 تثبيت التطبيق
          </div>
        `;
        
        document.body.appendChild(installButton);
        
        // إخفاء الزر بعد 10 ثوان
        setTimeout(() => {
          if (installButton.parentNode) {
            installButton.remove();
          }
        }, 10000);
      }
      
      // دالة تثبيت PWA
      window.installPWA = async function() {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          console.log(`PWA installation ${outcome}`);
          deferredPrompt = null;
          
          // إزالة زر التثبيت
          const installButtons = document.querySelectorAll('[onclick="installPWA()"]');
          installButtons.forEach(btn => btn.remove());
        }
      };
      
      // تحسين تجربة المستخدم للتطبيق المثبت
      window.addEventListener('appinstalled', () => {
        console.log('✅ PWA installed successfully');
        deferredPrompt = null;
        
        // إظهار رسالة نجح التثبيت
        const successMessage = document.createElement('div');
        successMessage.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: #10b981;
          color: white;
          padding: 20px;
          border-radius: 12px;
          z-index: 10000;
          font-size: 16px;
          font-weight: 600;
          text-align: center;
          direction: rtl;
          box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        `;
        successMessage.innerHTML = `
          <div>✅ تم تثبيت التطبيق بنجاح!</div>
          <div style="font-size: 14px; margin-top: 8px; opacity: 0.9;">
            يمكنك الآن الوصول للتطبيق من الشاشة الرئيسية
          </div>
        `;
        document.body.appendChild(successMessage);
        
        setTimeout(() => {
          if (successMessage.parentNode) {
            successMessage.remove();
          }
        }, 3000);
      });
      
      // منع تحديد النص في وضع standalone
      if (window.matchMedia('(display-mode: standalone)').matches) {
        document.addEventListener('selectstart', (e) => {
          if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
            e.preventDefault();
          }
        });
      }
      
      // تحسين الأداء للجوال
      if (/Mobi|Android/i.test(navigator.userAgent)) {
        // تعطيل zoom على double tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (event) => {
          const now = Date.now();
          if (now - lastTouchEnd <= 300) {
            event.preventDefault();
          }
          lastTouchEnd = now;
        }, false);
        
        // منع سحب الصفحة للأسفل أكثر من اللازم
        document.addEventListener('touchmove', (e) => {
          if (e.touches.length > 1) {
            e.preventDefault();
          }
        }, { passive: false });
      }
    </script>
    
    <!-- Advanced offline mode protection -->
    <script>
      // Global offline protection system
      window.HSAOfflineProtection = {
        isOffline: false,
        preventRefresh: true,
        
        init: function() {
          this.updateOfflineStatus();
          this.setupEventListeners();
          this.protectNavigation();
          console.log('🛡️ Offline protection system initialized');
        },
        
        updateOfflineStatus: function() {
          this.isOffline = !navigator.onLine;
          console.log('📡 Offline status:', this.isOffline);
        },
        
        setupEventListeners: function() {
          const self = this;
          
          // Monitor online/offline status
          window.addEventListener('online', () => {
            self.updateOfflineStatus();
            console.log('✅ Back online - refresh protection disabled');
          });
          
          window.addEventListener('offline', () => {
            self.updateOfflineStatus();
            console.log('❌ Gone offline - refresh protection enabled');
          });
          
          // Prevent keyboard shortcuts when offline
          document.addEventListener('keydown', function(e) {
            if (!self.isOffline) return;
            
            // F5, Ctrl+R, Cmd+R
            if (e.key === 'F5' || e.keyCode === 116 || 
                ((e.ctrlKey || e.metaKey) && (e.key === 'r' || e.key === 'R'))) {
              e.preventDefault();
              e.stopPropagation();
              self.showOfflineMessage();
              return false;
            }
          }, true);
          
          // Prevent page unload when offline
          window.addEventListener('beforeunload', function(e) {
            if (!self.isOffline) return;
            
            e.preventDefault();
            e.returnValue = 'التطبيق يعمل في وضع عدم الاتصال';
            return 'التطبيق يعمل في وضع عدم الاتصال';
          });
          
          // Handle browser back/forward in offline mode
          window.addEventListener('popstate', function(e) {
            if (!self.isOffline) return;
            
            e.preventDefault();
            history.pushState(null, '', location.href);
            self.showOfflineMessage();
          });
          
          // Prevent pull-to-refresh
          let startY = 0;
          document.addEventListener('touchstart', function(e) {
            if (!self.isOffline) return;
            startY = e.touches[0].clientY;
          }, { passive: true });
          
          document.addEventListener('touchmove', function(e) {
            if (!self.isOffline) return;
            
            const currentY = e.touches[0].clientY;
            if (window.scrollY === 0 && currentY > startY) {
              e.preventDefault();
              self.showOfflineMessage();
            }
          }, { passive: false });
        },
        
        protectNavigation: function() {
          // Inject navigation state
          if (history.state === null) {
            history.replaceState({ protected: true }, '', location.href);
          }
        },
        
        showOfflineMessage: function() {
          if (this.messageShown) return;
          this.messageShown = true;
          
          console.log('🚫 Refresh blocked - app running offline');
          
          // Create temporary notification
          const notification = document.createElement('div');
          notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ef4444;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 10000;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            direction: rtl;
          `;
          notification.textContent = 'التطبيق يعمل في وضع عدم الاتصال';
          document.body.appendChild(notification);
          
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
            this.messageShown = false;
          }, 2000);
        }
      };
      
      // Initialize protection when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          window.HSAOfflineProtection.init();
        });
      } else {
        window.HSAOfflineProtection.init();
      }
      
      // Log successful initialization
      console.log('🛡️ HSA Offline Protection System loaded and ready');
      
      // Additional protection for iOS Safari
      document.addEventListener('touchstart', function(){}, {passive: true});
      
      // Prevent zoom on double tap for better UX
      let lastTouchEnd = 0;
      document.addEventListener('touchend', function (event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
          event.preventDefault();
        }
        lastTouchEnd = now;
      }, false);
    </script>
  </body>
</html>