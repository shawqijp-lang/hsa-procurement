<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            direction: rtl;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1f2937;
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }
        .status-card {
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
        }
        .online { background: #d1fae5; color: #065f46; border: 2px solid #10b981; }
        .offline { background: #fee2e2; color: #991b1b; border: 2px solid #ef4444; }
        .btn {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #1f2937;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            width: 100%;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .log {
            background: #1f2937;
            color: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.6;
        }
        .counter {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
        }
        .save-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            font-size: 18px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-section {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h1>
        
        <div class="status-card" id="connectionStatus">â³ ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„...</div>
        
        <div class="counter" id="pendingCounter">
            Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©: <span id="pendingCount">0</span>
        </div>
        
        <div class="test-section">
            <h3>ğŸ¯ Ù…Ø­Ø§ÙƒØ§Ø© ØªÙ‚ÙŠÙŠÙ… Ù…Ø¨Ø§Ø´Ø±</h3>
            <p>Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙŠØ­Ø§ÙƒÙŠ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…" Ù…Ø¨Ø§Ø´Ø±Ø©</p>
            <button class="btn save-btn" onclick="testDirectSave()">ğŸ’¾ Ø­ÙØ¸ ØªÙ‚ÙŠÙŠÙ… Ù…Ø¨Ø§Ø´Ø±</button>
        </div>
        
        <button class="btn" onclick="testLocalStorageAccess()">ğŸ” Ø§Ø®ØªØ¨Ø§Ø± localStorage</button>
        <button class="btn" onclick="showSavedEvaluations()">ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</button>
        <button class="btn" onclick="clearAllData()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <button class="btn" onclick="testMultipleSaves()">ğŸ“Š Ø§Ø®ØªØ¨Ø§Ø± Ø­ÙØ¸ Ù…ØªØ¹Ø¯Ø¯</button>
        
        <div class="log" id="log">ğŸ“ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·:\n</div>
    </div>

    <script>
        let saveCounter = 1;

        function log(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString('ar-EG');
            logEl.textContent += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }

        function updateConnectionStatus() {
            const statusEl = document.getElementById('connectionStatus');
            
            if (navigator.onLine) {
                statusEl.className = 'status-card online';
                statusEl.textContent = 'âœ… Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';
            } else {
                statusEl.className = 'status-card offline';
                statusEl.textContent = 'âŒ ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';
            }
            updateCounter();
        }

        function updateCounter() {
            try {
                const data = localStorage.getItem('offline_evaluations');
                const evaluations = data ? JSON.parse(data) : [];
                
                document.getElementById('pendingCount').textContent = evaluations.length;
                
                if (evaluations.length > 0) {
                    document.getElementById('pendingCounter').style.background = '#d1fae5';
                    document.getElementById('pendingCounter').style.borderColor = '#10b981';
                } else {
                    document.getElementById('pendingCounter').style.background = '#fef3c7';
                    document.getElementById('pendingCounter').style.borderColor = '#f59e0b';
                }
            } catch (error) {
                log('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯: ' + error.message);
            }
        }

        function testDirectSave() {
            log('ğŸ¯ Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±...');
            
            const evaluationData = {
                locationId: Math.floor(Math.random() * 5) + 1,
                userId: 4,
                evaluationDate: new Date().toISOString().split('T')[0],
                tasks: [
                    {
                        templateId: 1,
                        rating: Math.floor(Math.random() * 4) + 1,
                        notes: `ØªÙ‚ÙŠÙŠÙ… Ù…Ø¨Ø§Ø´Ø± Ø±Ù‚Ù… ${saveCounter}`,
                        subTaskRatings: []
                    },
                    {
                        templateId: 2,
                        rating: Math.floor(Math.random() * 4) + 1,
                        notes: `Ù…Ù„Ø§Ø­Ø¸Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© ${saveCounter}`,
                        subTaskRatings: []
                    }
                ]
            };

            log('ğŸ“ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ' + JSON.stringify(evaluationData, null, 2));

            try {
                // Ù…Ø­Ø§ÙƒØ§Ø© Ø¯Ø§Ù„Ø© saveOfflineEvaluation
                const evaluationId = `direct_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                const evaluation = {
                    ...evaluationData,
                    id: evaluationId,
                    timestamp: Date.now(),
                    synced: false,
                    saved_method: 'direct_test'
                };

                log('ğŸ’¾ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±...');

                // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
                let existing = [];
                try {
                    const existingData = localStorage.getItem('offline_evaluations');
                    existing = existingData ? JSON.parse(existingData) : [];
                    log('ğŸ“‹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©: ' + existing.length + ' ØªÙ‚ÙŠÙŠÙ…');
                } catch (parseError) {
                    log('âš ï¸ Ø¥Ù†Ø´Ø§Ø¡ Ù…ØµÙÙˆÙØ© Ø¬Ø¯ÙŠØ¯Ø©');
                    existing = [];
                }

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯
                existing.push(evaluation);

                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                localStorage.setItem('offline_evaluations', JSON.stringify(existing));

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­ÙØ¸
                const verifyData = localStorage.getItem('offline_evaluations');
                if (verifyData) {
                    const verifyEvaluations = JSON.parse(verifyData);
                    const savedEvaluation = verifyEvaluations.find(e => e.id === evaluationId);
                    
                    if (savedEvaluation) {
                        log('âœ… Ù†Ø¬Ø­ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±: ' + evaluationId);
                        log('ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª: ' + verifyEvaluations.length);
                        saveCounter++;
                        updateCounter();
                        return true;
                    } else {
                        log('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø­ÙÙˆØ¸');
                        return false;
                    }
                } else {
                    log('âŒ ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ­Ù‚Ù‚');
                    return false;
                }

            } catch (error) {
                log('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±: ' + error.message);
                return false;
            }
        }

        function testLocalStorageAccess() {
            log('ğŸ” Ø§Ø®ØªØ¨Ø§Ø± localStorage...');
            
            try {
                // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
                const testKey = 'test_key';
                const testValue = 'test_value';
                localStorage.setItem(testKey, testValue);
                
                // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
                const retrievedValue = localStorage.getItem(testKey);
                
                if (retrievedValue === testValue) {
                    log('âœ… localStorage ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
                    localStorage.removeItem(testKey);
                } else {
                    log('âŒ localStorage Ù„Ø§ ÙŠØ­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ… Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
                }
                
            } catch (error) {
                log('âŒ localStorage ØºÙŠØ± Ù…ØªØ§Ø­: ' + error.message);
            }
        }

        function showSavedEvaluations() {
            log('ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©...');
            
            try {
                const data = localStorage.getItem('offline_evaluations');
                if (!data) {
                    log('â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©');
                    return;
                }

                const evaluations = JSON.parse(data);
                log('ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª: ' + evaluations.length);
                
                evaluations.forEach((evaluation, index) => {
                    const date = new Date(evaluation.timestamp).toLocaleString('ar-EG');
                    log(`${index + 1}. ${evaluation.id}`);
                    log(`   - Ù…ÙˆÙ‚Ø¹: ${evaluation.locationId}`);
                    log(`   - Ù…Ù‡Ø§Ù…: ${evaluation.tasks?.length || 0}`);
                    log(`   - ØªØ§Ø±ÙŠØ®: ${date}`);
                    log(`   - Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø­ÙØ¸: ${evaluation.saved_method || 'Ø¹Ø§Ø¯ÙŠØ©'}`);
                });
                
            } catch (error) {
                log('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª: ' + error.message);
            }
        }

        function clearAllData() {
            try {
                localStorage.removeItem('offline_evaluations');
                log('ğŸ—‘ï¸ ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                saveCounter = 1;
                updateCounter();
            } catch (error) {
                log('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø³Ø­: ' + error.message);
            }
        }

        function testMultipleSaves() {
            log('ğŸ“Š Ø§Ø®ØªØ¨Ø§Ø± Ø­ÙØ¸ Ù…ØªØ¹Ø¯Ø¯...');
            
            let successCount = 0;
            const totalTests = 5;
            
            for (let i = 0; i < totalTests; i++) {
                setTimeout(() => {
                    log(`ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ø±Ù‚Ù… ${i + 1}...`);
                    const success = testDirectSave();
                    if (success) successCount++;
                    
                    if (i === totalTests - 1) {
                        log(`ğŸ‰ Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØªØ¹Ø¯Ø¯: ${successCount}/${totalTests} Ù†Ø¬Ø­`);
                    }
                }, i * 500);
            }
        }

        // Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        window.addEventListener('online', () => {
            log('ğŸŒ ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„');
            updateConnectionStatus();
        });

        window.addEventListener('offline', () => {
            log('ğŸ“± Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„');
            updateConnectionStatus();
        });

        // Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
        log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±');
        updateConnectionStatus();
        
        setTimeout(() => {
            log('â„¹ï¸ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± - Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø¹Ù„Ø§Ù‡');
        }, 500);
    </script>
</body>
</html>