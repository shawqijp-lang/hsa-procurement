<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­ÙØ¸ Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            direction: rtl;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1f2937;
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }
        .status-card {
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
        }
        .online { background: #d1fae5; color: #065f46; border: 2px solid #10b981; }
        .offline { background: #fee2e2; color: #991b1b; border: 2px solid #ef4444; }
        .btn {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #1f2937;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            width: 100%;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .log {
            background: #1f2937;
            color: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.6;
        }
        .info-card {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .counter {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ</h1>
        
        <div class="status-card" id="connectionStatus">â³ ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„...</div>
        
        <div class="counter" id="pendingCounter">
            Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©: <span id="pendingCount">0</span>
        </div>
        
        <button class="btn" onclick="simulateOfflineEvaluation()">ğŸ’¾ Ù…Ø­Ø§ÙƒØ§Ø© ØªÙ‚ÙŠÙŠÙ… Ù…Ø­Ù„ÙŠ</button>
        <button class="btn" onclick="testAutoSync()" id="syncBtn">ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</button>
        <button class="btn" onclick="showPendingEvaluations()">ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</button>
        <button class="btn" onclick="clearOfflineData()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©</button>
        <button class="btn" onclick="toggleConnection()" id="connectionBtn">ğŸ“¶ Ù‚Ø·Ø¹/ÙˆØµÙ„ Ø§Ù„Ø§ØªØµØ§Ù„</button>
        
        <div class="info-card">
            <strong>ÙƒÙŠÙÙŠØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</strong><br>
            1. Ø§Ø¶ØºØ· "Ù…Ø­Ø§ÙƒØ§Ø© ØªÙ‚ÙŠÙŠÙ… Ù…Ø­Ù„ÙŠ" Ù„Ø­ÙØ¸ ØªÙ‚ÙŠÙŠÙ… Ù…Ø­Ù„ÙŠØ§Ù‹<br>
            2. Ø§Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ¬Ø±Ø¨ Ø­ÙØ¸ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø£Ø®Ø±Ù‰<br>
            3. Ø£Ø¹Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©<br>
            4. Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙˆØ§Ù„Ø³Ø¬Ù„ Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
        </div>
        
        <div class="log" id="log">ğŸ“ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·:\n</div>
    </div>

    <script>
        let isOnline = navigator.onLine;
        let evaluationCounter = 1;

        function log(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString('ar-EG');
            logEl.textContent += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }

        function updateConnectionStatus() {
            const statusEl = document.getElementById('connectionStatus');
            const btnEl = document.getElementById('connectionBtn');
            const syncBtnEl = document.getElementById('syncBtn');
            
            if (isOnline) {
                statusEl.className = 'status-card online';
                statusEl.textContent = 'âœ… Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';
                btnEl.textContent = 'ğŸ“± Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ (Ù…Ø­Ø§ÙƒØ§Ø©)';
                syncBtnEl.disabled = false;
            } else {
                statusEl.className = 'status-card offline';
                statusEl.textContent = 'âŒ ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';
                btnEl.textContent = 'ğŸ“¶ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„';
                syncBtnEl.disabled = true;
            }
            updatePendingCounter();
        }

        function updatePendingCounter() {
            try {
                const data = localStorage.getItem('offline_evaluations');
                const evaluations = data ? JSON.parse(data) : [];
                const pending = evaluations.filter(eval => !eval.synced);
                
                document.getElementById('pendingCount').textContent = pending.length;
                
                if (pending.length > 0) {
                    document.getElementById('pendingCounter').style.background = '#fecaca';
                    document.getElementById('pendingCounter').style.borderColor = '#ef4444';
                } else {
                    document.getElementById('pendingCounter').style.background = '#d1fae5';
                    document.getElementById('pendingCounter').style.borderColor = '#10b981';
                }
            } catch (error) {
                log('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯: ' + error.message);
            }
        }

        function simulateOfflineEvaluation() {
            try {
                const evaluation = {
                    id: `test_${Date.now()}_${evaluationCounter}`,
                    locationId: Math.floor(Math.random() * 5) + 1,
                    userId: 4,
                    evaluationDate: new Date().toISOString().split('T')[0],
                    tasks: [
                        {
                            templateId: 1,
                            rating: Math.floor(Math.random() * 4) + 1,
                            notes: `Ù…Ù„Ø§Ø­Ø¸Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© ${evaluationCounter}`,
                            subTaskRatings: []
                        },
                        {
                            templateId: 2,
                            rating: Math.floor(Math.random() * 4) + 1,
                            notes: `Ù…Ù„Ø§Ø­Ø¸Ø© Ø£Ø®Ø±Ù‰ ${evaluationCounter}`,
                            subTaskRatings: []
                        }
                    ],
                    timestamp: Date.now(),
                    synced: false
                };

                // Ø­ÙØ¸ ÙÙŠ localStorage
                const existingData = localStorage.getItem('offline_evaluations');
                const evaluations = existingData ? JSON.parse(existingData) : [];
                evaluations.push(evaluation);
                localStorage.setItem('offline_evaluations', JSON.stringify(evaluations));

                log(`âœ… ØªÙ… Ø­ÙØ¸ ØªÙ‚ÙŠÙŠÙ… ØªØ¬Ø±ÙŠØ¨ÙŠ Ø±Ù‚Ù… ${evaluationCounter} Ù…Ø­Ù„ÙŠØ§Ù‹`);
                log(`ğŸ“Š Ù…Ø¹Ø±Ù Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${evaluation.id}`);
                log(`ğŸ“ Ù…ÙˆÙ‚Ø¹: ${evaluation.locationId}, Ù…Ù‡Ø§Ù…: ${evaluation.tasks.length}`);
                
                evaluationCounter++;
                updatePendingCounter();
                
                if (isOnline && Math.random() > 0.3) {
                    setTimeout(() => {
                        log('ğŸ”„ Ù…Ø­Ø§ÙƒØ§Ø© Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©...');
                        simulateAutoSync();
                    }, 2000);
                }
                
            } catch (error) {
                log('âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ' + error.message);
            }
        }

        function simulateAutoSync() {
            if (!isOnline) {
                log('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© - ØºÙŠØ± Ù…ØªØµÙ„');
                return;
            }

            try {
                const data = localStorage.getItem('offline_evaluations');
                if (!data) {
                    log('â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©');
                    return;
                }

                const evaluations = JSON.parse(data);
                const pendingEvaluations = evaluations.filter(eval => !eval.synced);
                
                if (pendingEvaluations.length === 0) {
                    log('â„¹ï¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù…ØªØ²Ø§Ù…Ù†Ø© Ø¨Ø§Ù„ÙØ¹Ù„');
                    return;
                }

                log(`ğŸ”„ Ø¨Ø¯Ø¡ Ù…Ø²Ø§Ù…Ù†Ø© ${pendingEvaluations.length} ØªÙ‚ÙŠÙŠÙ…...`);
                
                // Ù…Ø­Ø§ÙƒØ§Ø© Ù…Ø²Ø§Ù…Ù†Ø© ØªØ¯Ø±ÙŠØ¬ÙŠØ©
                let syncedCount = 0;
                pendingEvaluations.forEach((evaluation, index) => {
                    setTimeout(() => {
                        // Ù…Ø­Ø§ÙƒØ§Ø© Ù†Ø¬Ø§Ø­ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© (90% Ù†Ø¬Ø§Ø­)
                        const success = Math.random() > 0.1;
                        
                        if (success) {
                            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
                            const allEvaluations = JSON.parse(localStorage.getItem('offline_evaluations') || '[]');
                            const updatedEvaluations = allEvaluations.map(eval => 
                                eval.id === evaluation.id ? { ...eval, synced: true } : eval
                            );
                            localStorage.setItem('offline_evaluations', JSON.stringify(updatedEvaluations));
                            
                            syncedCount++;
                            log(`âœ… ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${evaluation.id}`);
                        } else {
                            log(`âŒ ÙØ´Ù„ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${evaluation.id}`);
                        }
                        
                        if (index === pendingEvaluations.length - 1) {
                            log(`ğŸ‰ Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ${syncedCount}/${pendingEvaluations.length} Ø¨Ù†Ø¬Ø§Ø­`);
                            updatePendingCounter();
                            
                            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø©
                            setTimeout(() => {
                                cleanupSyncedEvaluations();
                            }, 1000);
                        }
                        
                        updatePendingCounter();
                    }, (index + 1) * 800);
                });
                
            } catch (error) {
                log('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ' + error.message);
            }
        }

        function cleanupSyncedEvaluations() {
            try {
                const data = localStorage.getItem('offline_evaluations');
                if (!data) return;
                
                const evaluations = JSON.parse(data);
                const unsyncedEvaluations = evaluations.filter(eval => !eval.synced);
                
                localStorage.setItem('offline_evaluations', JSON.stringify(unsyncedEvaluations));
                
                const removedCount = evaluations.length - unsyncedEvaluations.length;
                if (removedCount > 0) {
                    log(`ğŸ—‘ï¸ ØªÙ… ØªÙ†Ø¸ÙŠÙ ${removedCount} ØªÙ‚ÙŠÙŠÙ… Ù…ØªØ²Ø§Ù…Ù†`);
                }
                
                updatePendingCounter();
            } catch (error) {
                log('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ†Ø¸ÙŠÙ: ' + error.message);
            }
        }

        function testAutoSync() {
            log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©...');
            simulateAutoSync();
        }

        function showPendingEvaluations() {
            try {
                const data = localStorage.getItem('offline_evaluations');
                if (!data) {
                    log('ğŸ“‹ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©');
                    return;
                }

                const evaluations = JSON.parse(data);
                const pending = evaluations.filter(eval => !eval.synced);
                const synced = evaluations.filter(eval => eval.synced);
                
                log('ğŸ“‹ === ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª ===');
                log(`ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª: ${evaluations.length}`);
                log(`â³ Ù…Ø¹Ù„Ù‚Ø©: ${pending.length}`);
                log(`âœ… Ù…ØªØ²Ø§Ù…Ù†Ø©: ${synced.length}`);
                
                if (pending.length > 0) {
                    log('--- Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© ---');
                    pending.forEach((eval, index) => {
                        const date = new Date(eval.timestamp).toLocaleString('ar-EG');
                        log(`${index + 1}. ${eval.id} - Ù…ÙˆÙ‚Ø¹: ${eval.locationId} - ${date}`);
                    });
                }
                
            } catch (error) {
                log('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª: ' + error.message);
            }
        }

        function clearOfflineData() {
            try {
                localStorage.removeItem('offline_evaluations');
                log('ğŸ—‘ï¸ ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
                evaluationCounter = 1;
                updatePendingCounter();
            } catch (error) {
                log('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø³Ø­: ' + error.message);
            }
        }

        function toggleConnection() {
            isOnline = !isOnline;
            log(isOnline ? 'ğŸ“¶ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª' : 'ğŸ“± ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„');
            updateConnectionStatus();
            
            if (isOnline) {
                // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¹Ù†Ø¯ Ø¹ÙˆØ¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                setTimeout(() => {
                    const pendingCount = JSON.parse(localStorage.getItem('offline_evaluations') || '[]')
                        .filter(eval => !eval.synced).length;
                    
                    if (pendingCount > 0) {
                        log('ğŸŒ Ø§ÙƒØªØ´Ø§Ù Ø¹ÙˆØ¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ - Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©...');
                        simulateAutoSync();
                    }
                }, 3000);
            }
        }

        // Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        window.addEventListener('online', () => {
            isOnline = true;
            log('ğŸŒ ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©');
            updateConnectionStatus();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            log('ğŸ“± Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©');
            updateConnectionStatus();
        });

        // Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
        log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ');
        updateConnectionStatus();
        updatePendingCounter();
        
        // Ø¥Ø¶Ø§ÙØ© Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©
        setTimeout(() => {
            log('â„¹ï¸ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± - Ø¬Ø±Ø¨ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø¹Ù„Ø§Ù‡');
        }, 500);
    </script>
</body>
</html>