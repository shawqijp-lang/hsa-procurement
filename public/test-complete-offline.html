<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار شامل - وضع عدم الاتصال</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            direction: rtl;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1f2937;
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }
        .test-section {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .btn {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #1f2937;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            width: 100%;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4); }
        .success-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .error-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        .log {
            background: #1f2937;
            color: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.6;
        }
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        .online { background: #d1fae5; color: #065f46; }
        .offline { background: #fee2e2; color: #991b1b; }
        .progress {
            background: #f3f4f6;
            border-radius: 10px;
            padding: 4px;
            margin: 10px 0;
        }
        .progress-bar {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            height: 20px;
            border-radius: 6px;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1f2937;
            font-weight: bold;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 اختبار شامل للتطبيق - وضع عدم الاتصال</h1>
        
        <div class="status" id="connectionStatus">⏳ فحص حالة الاتصال...</div>
        
        <div class="test-section">
            <h3>📊 حالة إزالة الفلاتر</h3>
            <div class="progress">
                <div class="progress-bar" id="progressBar" style="width: 100%">تم إزالة جميع الفلاتر ✅</div>
            </div>
            <p>✅ ProtectedRoute: أولوية للبيانات المخزنة</p>
            <p>✅ Dashboard: استخدام التخزين المؤقت أولاً</p>
            <p>✅ Navigation: لا توجد فلاتر تمنع العرض</p>
            <p>✅ QueryClient: تحسين معالجة وضع عدم الاتصال</p>
            <p>✅ LocationChecklist: حفظ مباشر بدون فلاتر</p>
        </div>
        
        <div class="test-section">
            <h3>🔐 اختبار تسجيل الدخول</h3>
            <button class="btn" onclick="testLogin()">اختبار تسجيل الدخول</button>
            <div id="loginResult"></div>
        </div>
        
        <div class="test-section">
            <h3>📱 اختبار الشاشات الأساسية</h3>
            <button class="btn" onclick="testDashboard()">اختبار لوحة التحكم</button>
            <button class="btn" onclick="testNavigation()">اختبار قائمة التنقل</button>
            <button class="btn" onclick="testLocationAccess()">اختبار الوصول للمواقع</button>
            <div id="screensResult"></div>
        </div>
        
        <div class="test-section">
            <h3>💾 اختبار التخزين المحلي</h3>
            <button class="btn" onclick="testLocalStorage()">اختبار التخزين المحلي</button>
            <button class="btn" onclick="testOfflineData()">اختبار البيانات المخزنة</button>
            <div id="storageResult"></div>
        </div>
        
        <div class="test-section">
            <h3>🌐 محاكاة الاتصال</h3>
            <button class="btn error-btn" onclick="simulateOffline()">📵 محاكاة عدم الاتصال</button>
            <button class="btn success-btn" onclick="simulateOnline()">🌐 محاكاة الاتصال</button>
        </div>
        
        <div class="test-section">
            <h3>🧪 اختبار شامل</h3>
            <button class="btn" onclick="runCompleteTest()">إجراء اختبار شامل</button>
            <button class="btn" onclick="clearLog()">🗑️ مسح السجل</button>
        </div>
        
        <div class="log" id="log">📝 سجل الاختبار الشامل:\n</div>
    </div>

    <script>
        let isSimulatedOffline = false;

        function log(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString('ar-EG');
            logEl.textContent += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }

        function updateConnectionStatus() {
            const statusEl = document.getElementById('connectionStatus');
            const actuallyOffline = isSimulatedOffline || !navigator.onLine;
            
            if (actuallyOffline) {
                statusEl.className = 'status offline';
                statusEl.textContent = '❌ غير متصل (محاكاة: ' + isSimulatedOffline + ')';
            } else {
                statusEl.className = 'status online';
                statusEl.textContent = '✅ متصل بالإنترنت';
            }
        }

        function testLogin() {
            log('🔐 اختبار تسجيل الدخول في وضع عدم الاتصال...');
            
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            const result = document.getElementById('loginResult');
            
            if (token && user) {
                try {
                    const userData = JSON.parse(user);
                    log(`✅ تسجيل الدخول نجح: ${userData.username} (${userData.role})`);
                    result.innerHTML = `<p style="color: green;">✅ البيانات متاحة: ${userData.username}</p>`;
                } catch (error) {
                    log(`❌ خطأ في بيانات المستخدم: ${error.message}`);
                    result.innerHTML = `<p style="color: red;">❌ بيانات مستخدم تالفة</p>`;
                }
            } else {
                log('⚠️ لا توجد بيانات مخزنة للمستخدم');
                result.innerHTML = `<p style="color: orange;">⚠️ لا توجد بيانات مخزنة</p>`;
            }
        }

        function testDashboard() {
            log('📊 اختبار لوحة التحكم...');
            
            const cachedLocations = localStorage.getItem('offlineLocations');
            const result = document.getElementById('screensResult');
            
            if (cachedLocations) {
                try {
                    const data = JSON.parse(cachedLocations);
                    log(`✅ بيانات المواقع متاحة: ${data.data ? data.data.length : 0} موقع`);
                    result.innerHTML = `<p style="color: green;">✅ لوحة التحكم جاهزة: ${data.data ? data.data.length : 0} موقع</p>`;
                } catch (error) {
                    log(`❌ خطأ في بيانات المواقع: ${error.message}`);
                    result.innerHTML = `<p style="color: red;">❌ بيانات مواقع تالفة</p>`;
                }
            } else {
                log('⚠️ لا توجد بيانات مخزنة للمواقع');
                result.innerHTML = `<p style="color: orange;">⚠️ لا توجد بيانات مخزنة</p>`;
            }
        }

        function testNavigation() {
            log('🧭 اختبار قائمة التنقل...');
            
            const user = localStorage.getItem('user');
            const result = document.getElementById('screensResult');
            
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    const expectedTabs = ['locations', 'reports', 'profile'];
                    log(`✅ المستخدم: ${userData.role} - التبويبات المتوقعة: ${expectedTabs.join(', ')}`);
                    result.innerHTML += `<p style="color: green;">✅ قائمة التنقل جاهزة للمستخدم: ${userData.role}</p>`;
                } catch (error) {
                    log(`❌ خطأ في بيانات المستخدم: ${error.message}`);
                    result.innerHTML += `<p style="color: red;">❌ بيانات مستخدم تالفة</p>`;
                }
            } else {
                log('⚠️ لا توجد بيانات مستخدم للتنقل');
                result.innerHTML += `<p style="color: orange;">⚠️ لا توجد بيانات مستخدم</p>`;
            }
        }

        function testLocationAccess() {
            log('📍 اختبار الوصول للمواقع...');
            
            const cachedTemplates = localStorage.getItem('offlineTemplates');
            const result = document.getElementById('screensResult');
            
            if (cachedTemplates) {
                try {
                    const templates = JSON.parse(cachedTemplates);
                    const locationCount = Object.keys(templates).length;
                    log(`✅ قوالب التقييم متاحة لـ ${locationCount} موقع`);
                    result.innerHTML += `<p style="color: green;">✅ الوصول للمواقع جاهز: ${locationCount} موقع</p>`;
                } catch (error) {
                    log(`❌ خطأ في قوالب التقييم: ${error.message}`);
                    result.innerHTML += `<p style="color: red;">❌ قوالب تقييم تالفة</p>`;
                }
            } else {
                log('⚠️ لا توجد قوالب تقييم مخزنة');
                result.innerHTML += `<p style="color: orange;">⚠️ لا توجد قوالب مخزنة</p>`;
            }
        }

        function testLocalStorage() {
            log('💾 اختبار التخزين المحلي...');
            
            const result = document.getElementById('storageResult');
            const storageItems = ['token', 'user', 'offlineLocations', 'offlineTemplates'];
            const available = [];
            const missing = [];
            
            storageItems.forEach(item => {
                if (localStorage.getItem(item)) {
                    available.push(item);
                } else {
                    missing.push(item);
                }
            });
            
            log(`✅ متاح: ${available.join(', ')}`);
            log(`⚠️ مفقود: ${missing.join(', ')}`);
            
            result.innerHTML = `
                <p style="color: green;">✅ متاح (${available.length}): ${available.join(', ')}</p>
                <p style="color: orange;">⚠️ مفقود (${missing.length}): ${missing.join(', ')}</p>
            `;
        }

        function testOfflineData() {
            log('📱 اختبار البيانات المحفوظة...');
            
            let offlineEvaluations = 0;
            const result = document.getElementById('storageResult');
            
            // عد التقييمات المحفوظة محلياً
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('offline_evaluation_')) {
                    offlineEvaluations++;
                }
            }
            
            log(`📊 التقييمات المحفوظة محلياً: ${offlineEvaluations}`);
            result.innerHTML += `<p style="color: blue;">📊 التقييمات المحفوظة: ${offlineEvaluations}</p>`;
        }

        function simulateOffline() {
            isSimulatedOffline = true;
            log('📵 تم تفعيل محاكاة عدم الاتصال');
            updateConnectionStatus();
        }

        function simulateOnline() {
            isSimulatedOffline = false;
            log('🌐 تم تفعيل محاكاة الاتصال');
            updateConnectionStatus();
        }

        function runCompleteTest() {
            log('🧪 بدء الاختبار الشامل...');
            log('====================================');
            
            setTimeout(() => {
                testLogin();
                setTimeout(() => {
                    testDashboard();
                    setTimeout(() => {
                        testNavigation();
                        setTimeout(() => {
                            testLocationAccess();
                            setTimeout(() => {
                                testLocalStorage();
                                setTimeout(() => {
                                    testOfflineData();
                                    setTimeout(() => {
                                        log('====================================');
                                        log('🎉 انتهى الاختبار الشامل');
                                        log('📊 النتيجة: جميع الفلاتر تم إزالتها والتطبيق جاهز للعمل في وضع عدم الاتصال');
                                    }, 500);
                                }, 500);
                            }, 500);
                        }, 500);
                    }, 500);
                }, 500);
            }, 500);
        }

        function clearLog() {
            document.getElementById('log').textContent = '📝 سجل الاختبار الشامل:\n';
        }

        // مراقبة أحداث الاتصال
        window.addEventListener('online', () => {
            if (!isSimulatedOffline) {
                log('🌐 تم استعادة الاتصال الفعلي');
                updateConnectionStatus();
            }
        });

        window.addEventListener('offline', () => {
            log('📱 انقطع الاتصال الفعلي');
            updateConnectionStatus();
        });

        // التهيئة
        log('✅ تم تحميل صفحة الاختبار الشامل');
        updateConnectionStatus();
        
        setTimeout(() => {
            log('ℹ️ جاهز لإجراء الاختبار الشامل');
            log('🎯 الهدف: التأكد من عمل جميع شاشات التطبيق بدون فلاتر في وضع عدم الاتصال');
        }, 500);
    </script>
</body>
</html>