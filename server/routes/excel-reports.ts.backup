/**
 * ğŸ“Š Ù…Ø³Ø§Ø±Ø§Øª ØªÙ‚Ø§Ø±ÙŠØ± Excel Ù…Ø­Ø¯Ø«Ø© - Ù†Ø¸Ø§Ù… HSA
 * ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ù…Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ÙˆØ§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©
 */

import express from 'express';
import ExcelJS from 'exceljs';
import { db } from '../db';
import { dailyChecklists, checklistTemplates, users, locations, companies } from '../../shared/schema';
import { eq, and, gte, lte, inArray, desc } from 'drizzle-orm';
import jwt from 'jsonwebtoken';
import { storage } from '../storage';

const router = express.Router();

// Enhanced security: No fallback for production
const JWT_SECRET = process.env.JWT_SECRET || (() => {
  if (process.env.NODE_ENV === 'production') {
    throw new Error('JWT_SECRET must be set in production environment');
  }
  return "dev-secret-key-2025"; // Only for development
})();

// Authentication middleware
async function authenticateToken(req: any, res: any, next: any) {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1];

  if (!token) {
    return res.status(401).json({ message: 'Access token required' });
  }

  try {
    const decoded = jwt.verify(token, JWT_SECRET) as any;
    const userId = decoded.id || decoded.userId;
    
    if (!userId) {
      return res.status(403).json({ message: 'Invalid token format' });
    }
    
    const user = await storage.getUser(userId);
    if (!user || !user.isActive) {
      return res.status(401).json({ message: 'User not found or inactive' });
    }
    
    req.user = user;
    req.userCompanyId = user.companyId;
    next();
  } catch (error) {
    return res.status(403).json({ message: 'Invalid token' });
  }
}

/**
 * ğŸ“Š ØªÙ‚Ø±ÙŠØ± Excel Ù„Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© - Ù…Ø­Ø¯Ø« 2025
 */
router.get('/evaluations', authenticateToken, async (req: any, res) => {
  try {
    console.log('ğŸ“Š Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Excel Ù„Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©...');
    
    const {
      startDate,
      endDate,
      locationId,
      userId,
      companyId
    } = req.query;
    
    const currentUser = req.user;
    const userCompanyId = currentUser.companyId;
    
    // Ø¨Ù†Ø§Ø¡ Ø´Ø±ÙˆØ· Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    const conditions = [];
    
    // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø£Ù…Ø§Ù† Ø£Ø³Ø§Ø³ÙŠ)
    if (currentUser.role !== 'general_manager') {
      conditions.push(eq(dailyChecklists.companyId, userCompanyId));
    } else if (companyId && companyId !== 'all') {
      conditions.push(eq(dailyChecklists.companyId, parseInt(companyId)));
    }
    
    // ÙÙ„ØªØ±Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
    if (startDate) {
      conditions.push(gte(dailyChecklists.checklistDate, startDate));
    }
    if (endDate) {
      conditions.push(lte(dailyChecklists.checklistDate, endDate));
    }
    
    // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹
    if (locationId && locationId !== 'all') {
      conditions.push(eq(dailyChecklists.locationId, parseInt(locationId)));
    }
    
    // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if (userId && userId !== 'all') {
      conditions.push(eq(dailyChecklists.userId, parseInt(userId)));
    }

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const evaluationsData = await db
      .select({
        evaluation: dailyChecklists,
        user: users,
        location: locations,
        company: companies
      })
      .from(dailyChecklists)
      .leftJoin(users, eq(dailyChecklists.userId, users.id))
      .leftJoin(locations, eq(dailyChecklists.locationId, locations.id))
      .leftJoin(companies, eq(dailyChecklists.companyId, companies.id))
      .where(conditions.length > 0 ? and(...conditions) : undefined)
      .orderBy(desc(dailyChecklists.checklistDate), desc(dailyChecklists.id));

    // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù‡Ø§Ù…
    const allTemplates = await db
      .select()
      .from(checklistTemplates);

    // Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø±ÙŠØ·Ø© Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ Ù„Ù„Ù‚ÙˆØ§Ù„Ø¨
    const templatesMap = new Map();
    allTemplates.forEach(template => {
      templatesMap.set(template.id, template);
    });

    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel Ø¬Ø¯ÙŠØ¯
    const workbook = new ExcelJS.Workbook();
    workbook.creator = 'Ù†Ø¸Ø§Ù… HSA Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¹Ù…Ù„';
    workbook.lastModifiedBy = currentUser.fullName || currentUser.username;
    workbook.created = new Date();

    // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø£ÙˆÙ„Ù‰: Ù…Ù„Ø®Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const summarySheet = workbook.addWorksheet('Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª', {
      pageSetup: { orientation: 'landscape', paperSize: 9 }
    });

    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    summarySheet.mergeCells('A1:G2');
    const headerCell = summarySheet.getCell('A1');
    headerCell.value = `ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© - Ù†Ø¸Ø§Ù… Ù‡Ø§Ø¦Ù„ Ø³Ø¹ÙŠØ¯ Ø£Ù†Ø¹Ù… ÙˆØ´Ø±ÙƒØ§Ù‡`;
    headerCell.font = { name: 'Arial', size: 16, bold: true, color: { argb: 'FFFFFF' } };
    headerCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD700' } };
    headerCell.alignment = { vertical: 'middle', horizontal: 'center' };
    headerCell.border = {
      top: { style: 'thick' },
      left: { style: 'thick' },
      bottom: { style: 'thick' },
      right: { style: 'thick' }
    };

    // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±
    summarySheet.getCell('A4').value = 'ØªØ§Ø±ÙŠØ® Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±:';
    summarySheet.getCell('B4').value = new Date().toLocaleDateString('ar-EG', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      calendar: 'gregory' 
    });
    
    summarySheet.getCell('A5').value = 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø©:';
    summarySheet.getCell('B5').value = currentUser.fullName || currentUser.username;
    
    if (startDate || endDate) {
      summarySheet.getCell('A6').value = 'ÙØªØ±Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±:';
      summarySheet.getCell('B6').value = `Ù…Ù† ${startDate || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} Ø¥Ù„Ù‰ ${endDate || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`;
    }

    // Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
    summarySheet.getCell('A8').value = 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª:';
    summarySheet.getCell('B8').value = evaluationsData.length;
    summarySheet.getCell('B8').font = { bold: true, color: { argb: '0066CC' } };

    // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø«Ø§Ù†ÙŠØ©: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©
    const detailSheet = workbook.addWorksheet('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©');

    // Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©
    const headers = [
      'Ø§Ù„ØªØ§Ø±ÙŠØ®',
      'ÙˆÙ‚Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ…', 
      'Ø§Ù„Ù…ÙˆÙ‚Ø¹',
      'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…',
      'Ø§Ù„Ø´Ø±ÙƒØ©',
      'Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø©',
      'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ…'
    ];

    // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
    headers.forEach((header, index) => {
      const cell = detailSheet.getCell(1, index + 1);
      cell.value = header;
      cell.font = { bold: true, color: { argb: 'FFFFFF' } };
      cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '4472C4' } };
      cell.alignment = { horizontal: 'center', vertical: 'middle' };
      cell.border = {
        top: { style: 'thin' },
        left: { style: 'thin' },
        bottom: { style: 'thin' },
        right: { style: 'thin' }
      };
    });

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    let currentRow = 2; // Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†

    for (const row of evaluationsData) {
      const evaluation = row.evaluation;
      const user = row.user;
      const location = row.location;
      const company = row.company;
      
      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‡Ø§Ù…
      let tasks = [];
      try {
        if (evaluation.tasks && typeof evaluation.tasks === 'string') {
          tasks = JSON.parse(evaluation.tasks);
        } else if (Array.isArray(evaluation.tasks)) {
          tasks = evaluation.tasks;
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‡Ø§Ù…:', error);
        tasks = [];
      }

      // ØªÙ†Ø³ÙŠÙ‚ ÙˆÙ‚Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
      const evaluationTime = evaluation.createdAt 
        ? new Date(evaluation.createdAt).toLocaleTimeString('ar-EG', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: false 
          })
        : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

      // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù…ØŒ Ø§Ø¹Ø±Ø¶ ØµÙ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·
      if (tasks.length === 0) {
        const rowData = [
          evaluation.checklistDate,
          evaluationTime,
          location?.nameAr || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
          user?.fullName || user?.username || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
          company?.nameAr || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
          'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù…',
          evaluation.evaluationNotes || ''
        ];

        rowData.forEach((data, colIndex) => {
          const cell = detailSheet.getCell(currentRow, colIndex + 1);
          cell.value = data;
          cell.alignment = { horizontal: 'center', vertical: 'middle' };
          cell.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
          };
        });
        currentRow++;
      } else {
        // Ø¹Ø±Ø¶ ÙƒÙ„ Ù…Ù‡Ù…Ø© ÙÙŠ ØµÙ Ù…Ù†ÙØµÙ„
        tasks.forEach((task: any, taskIndex: number) => {
          const isFirstTask = taskIndex === 0;
          
          // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ù„Ø¨
          const template = templatesMap.get(task.templateId);
          let taskName = 'Ù…Ù‡Ù…Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©';
          
          if (template) {
            taskName = template.nameAr || template.name || 'Ù…Ù‡Ù…Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©';
          }
          
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª ÙØ±Ø¹ÙŠØ©
          if (task.subTaskRatings && Array.isArray(task.subTaskRatings) && task.subTaskRatings.length > 0) {
            // Ø¹Ø±Ø¶ ÙƒÙ„ Ù…Ù‡Ù…Ø© ÙØ±Ø¹ÙŠØ© ÙÙŠ ØµÙ Ù…Ù†ÙØµÙ„
            task.subTaskRatings.forEach((subTask: any, subTaskIndex: number) => {
              const isFirstSubTask = subTaskIndex === 0;
              const isFirstOverall = isFirstTask && isFirstSubTask;
              
              const rowData = [
                isFirstOverall ? evaluation.checklistDate : '', // Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
                isFirstOverall ? evaluationTime : '', // Ø§Ù„ÙˆÙ‚Øª ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
                isFirstOverall ? (location?.nameAr || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') : '', // Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
                isFirstOverall ? (user?.fullName || user?.username || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') : '', // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
                isFirstOverall ? (company?.nameAr || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') : '', // Ø§Ù„Ø´Ø±ÙƒØ© ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
                isFirstSubTask ? taskName : '', // Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙ‚Ø·
                (taskIndex === 0 && subTaskIndex === 0) ? (evaluation.evaluationNotes || '') : '' // Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
              ];

              rowData.forEach((data, colIndex) => {
                const cell = detailSheet.getCell(currentRow, colIndex + 1);
                cell.value = data;
                cell.alignment = { horizontal: 'center', vertical: 'middle' };
                cell.border = {
                  top: { style: 'thin' },
                  left: { style: 'thin' },
                  bottom: { style: 'thin' },
                  right: { style: 'thin' }
                };
              });
              currentRow++;
            });
          } else {
            // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© (Ø¨Ø¯ÙˆÙ† Ù…Ù‡Ø§Ù… ÙØ±Ø¹ÙŠØ©)
            let evaluationCriteria = '-';
            
            if (template) {
              if (template.subPoints && Array.isArray(template.subPoints) && template.subPoints.length > 0) {
                evaluationCriteria = template.subPoints.map((point: any) => 
                  point.ar || point.nameAr || point.name || 'Ø¨Ù†Ø¯ ØºÙŠØ± Ù…Ø­Ø¯Ø¯'
                ).join(' | ');
              } else if (template.multiTasks && Array.isArray(template.multiTasks) && template.multiTasks.length > 0) {
                evaluationCriteria = template.multiTasks.map((multiTask: any) => 
                  multiTask.ar || multiTask.nameAr || multiTask.name || 'Ù…Ù‡Ù…Ø© Ù…ØªØ¹Ø¯Ø¯Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©'
                ).join(' | ');
              } else if (template.subTasks && Array.isArray(template.subTasks) && template.subTasks.length > 0) {
                evaluationCriteria = template.subTasks.map((subTask: any) => 
                  subTask.ar || subTask.nameAr || subTask.name || 'Ù…Ù‡Ù…Ø© ÙØ±Ø¹ÙŠØ© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©'
                ).join(' | ');
              } else if (template.category) {
                evaluationCriteria = template.category;
              }
            }
            
            // Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù„Ù„Ù…Ù‡Ù…Ø©
            let taskRating = task.rating || '0';
            if (task.subTaskRatings && Array.isArray(task.subTaskRatings) && task.subTaskRatings.length > 0) {
              const totalRating = task.subTaskRatings.reduce((sum: number, subTask: any) => sum + (subTask.rating || 0), 0);
              taskRating = task.subTaskRatings.length > 0 ? (totalRating / task.subTaskRatings.length).toFixed(1) : '0';
            }
            
            const rowData = [
              isFirstTask ? evaluation.checklistDate : '', // Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
              isFirstTask ? evaluationTime : '', // Ø§Ù„ÙˆÙ‚Øª ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
              isFirstTask ? (location?.nameAr || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') : '', // Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
              isFirstTask ? (user?.fullName || user?.username || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') : '', // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
              isFirstTask ? (company?.nameAr || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') : '', // Ø§Ù„Ø´Ø±ÙƒØ© ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
              taskName,
              taskIndex === 0 ? (evaluation.evaluationNotes || '') : '' // Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
            ];

            rowData.forEach((data, colIndex) => {
              const cell = detailSheet.getCell(currentRow, colIndex + 1);
              cell.value = data;
              cell.alignment = { horizontal: 'center', vertical: 'middle' };
              cell.border = {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
              };

              // ØªÙ„ÙˆÙŠÙ† Ù…Ø´Ø±ÙˆØ· Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
              if (colIndex === 5) { // Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…/Ø§Ù„Ù…Ù‡Ù…Ø©
                const rating = parseFloat(taskRating);
                if (rating >= 4) {
                  cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'C6EFCE' } };
                } else if (rating >= 3) {
                  cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEB9C' } };
                } else if (rating > 0) {
                  cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFC7CE' } };
                }
              }
            });
            currentRow++;
          }
        });
      }
    }

    // ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
    detailSheet.columns = [
      { width: 15 }, // Ø§Ù„ØªØ§Ø±ÙŠØ®
      { width: 12 }, // ÙˆÙ‚Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
      { width: 25 }, // Ø§Ù„Ù…ÙˆÙ‚Ø¹
      { width: 20 }, // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      { width: 20 }, // Ø§Ù„Ø´Ø±ÙƒØ©
      { width: 30 }, // Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø©
      { width: 30 }  // Ù…Ù„Ø§Ø­Ø¸Ø§Øª
    ];

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
    res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
    res.setHeader('Content-Disposition', `attachment; filename="evaluations_report_${new Date().toISOString().split('T')[0]}.xlsx"`);

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù
    await workbook.xlsx.write(res);
    res.end();

    console.log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Excel Ø¨Ù†Ø¬Ø§Ø­ - ${evaluationsData.length} Ø³Ø¬Ù„`);

  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Excel:', error);
    res.status(500).json({ 
      message: 'ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±',
      error: process.env.NODE_ENV === 'development' ? (error as Error).message : 'Ø®Ø·Ø£ Ø¯Ø§Ø®Ù„ÙŠ'
    });
  }
});

/**
 * ğŸ“‹ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ù„Ù„ÙÙ„ØªØ±Ø©
 */
router.get('/filter-locations/:companyId', authenticateToken, async (req: any, res) => {
  try {
    const { companyId } = req.params;
    const currentUser = req.user;
    
    let conditions = [];
    
    if (currentUser.role !== 'general_manager') {
      conditions.push(eq(locations.companyId, currentUser.companyId));
    } else if (companyId !== 'all') {
      conditions.push(eq(locations.companyId, parseInt(companyId)));
    }
    
    const locationsList = await db
      .select({
        id: locations.id,
        nameAr: locations.nameAr,
        icon: locations.icon
      })
      .from(locations)
      .where(conditions.length > 0 ? and(...conditions) : undefined)
      .orderBy(locations.nameAr);
    
    res.json(locationsList);
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹:', error);
    res.status(500).json({ message: 'ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹' });
  }
});

/**
 * ğŸ‘¥ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù„ÙÙ„ØªØ±Ø©
 */
router.get('/filter-users/:companyId', authenticateToken, async (req: any, res) => {
  try {
    const { companyId } = req.params;
    const currentUser = req.user;
    
    let conditions = [];
    
    if (currentUser.role !== 'general_manager') {
      conditions.push(eq(users.companyId, currentUser.companyId));
    } else if (companyId !== 'all') {
      conditions.push(eq(users.companyId, parseInt(companyId)));
    }
    
    const usersList = await db
      .select({
        id: users.id,
        username: users.username,
        fullName: users.fullName
      })
      .from(users)
      .where(conditions.length > 0 ? and(...conditions) : undefined)
      .orderBy(users.fullName);
    
    res.json(usersList);
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', error);
    res.status(500).json({ message: 'ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†' });
  }
});

/**
 * ğŸ“Š ØªÙ‚Ø±ÙŠØ± ØªÙØ§ØµÙŠÙ„ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
 */
router.get('/location-details', authenticateToken, async (req: any, res) => {
  try {
    console.log('ğŸ“Š Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± ØªÙØ§ØµÙŠÙ„ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹...');
    
    const currentUser = req.user;
    const userCompanyId = currentUser.companyId;
    
    // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„ÙØ­Øµ
    const allTemplates = await db.select().from(checklistTemplates);
    console.log('ğŸ“Š Total templates in DB:', allTemplates.length);
    console.log('ğŸ“Š Sample template IDs and names:', 
      allTemplates.slice(0, 10).map(t => `ID:${t.id} Name:${t.nameAr || t.name || 'NO_NAME'}`));
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø±ÙŠØ·Ø© Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ Ù„Ù„Ù‚ÙˆØ§Ù„Ø¨  
    const templatesMap = new Map();
    allTemplates.forEach(template => {
      templatesMap.set(template.id, template);
    });
    console.log('ğŸ“Š TemplatesMap created with size:', templatesMap.size);
    
    const { startDate, endDate, locationId, userId, companyId } = req.query;

    // Ø¨Ù†Ø§Ø¡ Ø´Ø±ÙˆØ· Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…
    let conditions = [];
    
    // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø£Ù…Ø§Ù† Ø£Ø³Ø§Ø³ÙŠ)
    if (currentUser.role !== 'general_manager') {
      conditions.push(eq(dailyChecklists.companyId, userCompanyId));
    } else if (companyId && companyId !== 'all') {
      conditions.push(eq(dailyChecklists.companyId, parseInt(companyId)));
    }
    
    // ÙÙ„ØªØ±Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
    if (startDate) {
      conditions.push(gte(dailyChecklists.checklistDate, startDate));
    }
    if (endDate) {
      conditions.push(lte(dailyChecklists.checklistDate, endDate));
    }
    
    // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹
    if (locationId && locationId !== 'all') {
      conditions.push(eq(dailyChecklists.locationId, parseInt(locationId)));
    }
    
    // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if (userId && userId !== 'all') {
      conditions.push(eq(dailyChecklists.userId, parseInt(userId)));
    }

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const evaluationsData = await db
      .select({
        evaluation: dailyChecklists,
        user: users,
        location: locations,
        company: companies
      })
      .from(dailyChecklists)
      .leftJoin(users, eq(dailyChecklists.userId, users.id))
      .leftJoin(locations, eq(dailyChecklists.locationId, locations.id))
      .leftJoin(companies, eq(dailyChecklists.companyId, companies.id))
      .where(conditions.length > 0 ? and(...conditions) : undefined)
      .orderBy(desc(dailyChecklists.checklistDate), desc(dailyChecklists.id));

    // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù‡Ø§Ù…
    const allTemplates = await db
      .select()
      .from(checklistTemplates);

    // Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø±ÙŠØ·Ø© Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ Ù„Ù„Ù‚ÙˆØ§Ù„Ø¨
    const templatesMap = new Map();
    allTemplates.forEach(template => {
      templatesMap.set(template.id, template);
    });

    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel Ø¬Ø¯ÙŠØ¯
    const workbook = new ExcelJS.Workbook();
    workbook.creator = 'Ù†Ø¸Ø§Ù… HSA Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¹Ù…Ù„';
    workbook.lastModifiedBy = currentUser.fullName || currentUser.username;
    workbook.created = new Date();

    // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„: ØªÙØ§ØµÙŠÙ„ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹
    const detailSheet = workbook.addWorksheet('ØªÙØ§ØµÙŠÙ„ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹');

    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    detailSheet.mergeCells('A1:J2');
    const headerCell = detailSheet.getCell('A1');
    headerCell.value = `ØªÙ‚Ø±ÙŠØ± ØªÙØ§ØµÙŠÙ„ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ - Ù†Ø¸Ø§Ù… Ù‡Ø§Ø¦Ù„ Ø³Ø¹ÙŠØ¯ Ø£Ù†Ø¹Ù… ÙˆØ´Ø±ÙƒØ§Ù‡`;
    headerCell.font = { name: 'Arial', size: 16, bold: true, color: { argb: 'FFFFFF' } };
    headerCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD700' } };
    headerCell.alignment = { vertical: 'middle', horizontal: 'center' };
    headerCell.border = {
      top: { style: 'thick' },
      left: { style: 'thick' },
      bottom: { style: 'thick' },
      right: { style: 'thick' }
    };

    // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±
    detailSheet.getCell('A4').value = 'ØªØ§Ø±ÙŠØ® Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±:';
    detailSheet.getCell('B4').value = new Date().toLocaleDateString('ar-EG', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      calendar: 'gregory' 
    });
    
    detailSheet.getCell('A5').value = 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø©:';
    detailSheet.getCell('B5').value = currentUser.fullName || currentUser.username;
    
    if (startDate || endDate) {
      detailSheet.getCell('A6').value = 'ÙØªØ±Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±:';
      detailSheet.getCell('B6').value = `Ù…Ù† ${startDate || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} Ø¥Ù„Ù‰ ${endDate || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`;
    }

    // Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©
    const headers = [
      'Ø§Ù„ØªØ§Ø±ÙŠØ®',
      'ÙˆÙ‚Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ…',
      'Ø§Ù„Ù…ÙˆÙ‚Ø¹', 
      'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…',
      'Ø§Ù„Ø´Ø±ÙƒØ©',
      'Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',
      'Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ©',
      'Ø§Ù„ØªÙ‚ÙŠÙŠÙ…',
      'Ù…ÙƒØªÙ…Ù„Ø©',
      'Ù…Ù„Ø§Ø­Ø¸Ø§Øª'
    ];

    // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ Ø§Ù„ØµÙ 8
    headers.forEach((header, index) => {
      const cell = detailSheet.getCell(8, index + 1);
      cell.value = header;
      cell.font = { bold: true, color: { argb: 'FFFFFF' } };
      cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '4472C4' } };
      cell.alignment = { horizontal: 'center', vertical: 'middle' };
      cell.border = {
        top: { style: 'thin' },
        left: { style: 'thin' },
        bottom: { style: 'thin' },
        right: { style: 'thin' }
      };
    });

    let currentRow = 9;

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    for (const row of evaluationsData) {
      const evaluation = row.evaluation;
      const user = row.user;
      const location = row.location;
      const company = row.company;
      
      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‡Ø§Ù…
      let tasks = [];
      try {
        if (evaluation.tasks && typeof evaluation.tasks === 'string') {
          tasks = JSON.parse(evaluation.tasks);
        } else if (Array.isArray(evaluation.tasks)) {
          tasks = evaluation.tasks;
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‡Ø§Ù…:', error);
        tasks = [];
      }

      // ØªÙ†Ø³ÙŠÙ‚ ÙˆÙ‚Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
      const evaluationTime = evaluation.createdAt 
        ? new Date(evaluation.createdAt).toLocaleTimeString('ar-EG', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: false 
          })
        : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

      // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù…ØŒ Ø§Ø¹Ø±Ø¶ ØµÙ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·
      if (tasks.length === 0) {
        const rowData = [
          evaluation.checklistDate,
          evaluationTime,
          location?.nameAr || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
          user?.fullName || user?.username || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
          company?.nameAr || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
          'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù…',
          '-',
          '-',
          '-',
          evaluation.evaluationNotes || ''
        ];

        rowData.forEach((data, colIndex) => {
          const cell = detailSheet.getCell(currentRow, colIndex + 1);
          cell.value = data;
          cell.alignment = { horizontal: 'center', vertical: 'middle' };
          cell.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
          };
        });
        currentRow++;
      } else {
        // Ø¹Ø±Ø¶ ÙƒÙ„ Ù…Ù‡Ù…Ø© ÙÙŠ ØµÙ Ù…Ù†ÙØµÙ„
        tasks.forEach((task: any, taskIndex: number) => {
          const isFirstTask = taskIndex === 0;
          
          // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø£Ùˆ Ø§Ù„Ù‚Ø§Ù„Ø¨
          let taskName = 'Ù…Ù‡Ù…Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©';
          
          // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù€ templateId
          const template = templatesMap.get(task.templateId);
          console.log('ğŸ“Š Looking for template ID:', task.templateId);
          console.log('ğŸ“Š Template found:', template ? `${template.nameAr || template.name}` : 'NOT FOUND');
          
          if (template) {
            taskName = template.nameAr || template.name || 'Ù‚Ø§Ù„Ø¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
          } else {
            taskName = `Ù…Ù‡Ù…Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© (ID: ${task.templateId})`;
          }
          
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª ÙØ±Ø¹ÙŠØ© Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ù„Ø¨
          let subTasksToDisplay = [];
          const template = templatesMap.get(task.templateId);
          
          if (task.subTaskRatings && Array.isArray(task.subTaskRatings) && task.subTaskRatings.length > 0) {
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ ØªÙ‚ÙŠÙŠÙ…Ø§Øª ÙØ±Ø¹ÙŠØ© Ù…Ø­ÙÙˆØ¸Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù…Ù‡Ø§
            subTasksToDisplay = task.subTaskRatings;
          } else if (template) {
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ù„Ø¨
            if (template.multiTasks && Array.isArray(template.multiTasks) && template.multiTasks.length > 0) {
              subTasksToDisplay = template.multiTasks.map((multiTask: any, index: number) => ({
                taskName: multiTask.ar || multiTask.nameAr || multiTask.name || `Ù…Ù‡Ù…Ø© Ù…ØªØ¹Ø¯Ø¯Ø© ${index + 1}`,
                rating: task.rating || 0,
                notes: task.notes || ''
              }));
            } else if (template.subTasks && Array.isArray(template.subTasks) && template.subTasks.length > 0) {
              subTasksToDisplay = template.subTasks.map((subTask: any, index: number) => ({
                taskName: subTask.ar || subTask.nameAr || subTask.name || `Ù…Ù‡Ù…Ø© ÙØ±Ø¹ÙŠØ© ${index + 1}`,
                rating: task.rating || 0,
                notes: task.notes || ''
              }));
            } else if (template.subPoints && Array.isArray(template.subPoints) && template.subPoints.length > 0) {
              subTasksToDisplay = template.subPoints.map((subPoint: any, index: number) => ({
                taskName: subPoint.ar || subPoint.nameAr || subPoint.name || `Ù†Ù‚Ø·Ø© ÙØ±Ø¹ÙŠØ© ${index + 1}`,
                rating: task.rating || 0,
                notes: task.notes || ''
              }));
            }
          }
          
          if (subTasksToDisplay.length > 0) {
            // Ø¹Ø±Ø¶ ÙƒÙ„ Ù…Ù‡Ù…Ø© ÙØ±Ø¹ÙŠØ© ÙÙŠ ØµÙ Ù…Ù†ÙØµÙ„
            subTasksToDisplay.forEach((subTask: any, subTaskIndex: number) => {
              const isFirstSubTask = subTaskIndex === 0;
              const isFirstOverall = isFirstTask && isFirstSubTask;
              
              const rowData = [
                isFirstOverall ? evaluation.checklistDate : '', // Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
                isFirstOverall ? evaluationTime : '', // Ø§Ù„ÙˆÙ‚Øª ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
                isFirstOverall ? (location?.nameAr || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') : '', // Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
                isFirstOverall ? (user?.fullName || user?.username || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') : '', // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
                isFirstOverall ? (company?.nameAr || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') : '', // Ø§Ù„Ø´Ø±ÙƒØ© ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
                isFirstSubTask ? taskName : '', // Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                subTask.taskName || 'Ù…Ù‡Ù…Ø© ÙØ±Ø¹ÙŠØ© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©', // Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ©
                subTask.rating || task.rating || '0', // ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ©
                (subTask.rating > 0 || task.rating > 0) ? 'Ù†Ø¹Ù…' : 'Ù„Ø§', // Ø­Ø§Ù„Ø© Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
                (taskIndex === 0 && subTaskIndex === 0) ? (evaluation.evaluationNotes || '') : '' // Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
              ];

              rowData.forEach((data, colIndex) => {
                const cell = detailSheet.getCell(currentRow, colIndex + 1);
                cell.value = data;
                cell.alignment = { horizontal: 'center', vertical: 'middle' };
                cell.border = {
                  top: { style: 'thin' },
                  left: { style: 'thin' },
                  bottom: { style: 'thin' },
                  right: { style: 'thin' }
                };

                // ØªÙ„ÙˆÙŠÙ† Ù…Ø´Ø±ÙˆØ· Ù„Ù„ØªÙ‚ÙŠÙŠÙ…
                if (colIndex === 7) { // Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
                  const rating = parseFloat(subTask.rating || task.rating || '0');
                  if (rating >= 4) {
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'C6EFCE' } };
                  } else if (rating >= 3) {
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEB9C' } };
                  } else if (rating > 0) {
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFC7CE' } };
                  }
                }

                // ØªÙ„ÙˆÙŠÙ† Ù…Ø´Ø±ÙˆØ· Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„
                if (colIndex === 8) { // Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„
                  const rating = parseFloat(subTask.rating || task.rating || '0');
                  if (rating > 0) {
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'C6EFCE' } };
                  } else {
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFC7CE' } };
                  }
                }
              });
              currentRow++;
            });
          } else {
            // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© (Ø¨Ø¯ÙˆÙ† Ù…Ù‡Ø§Ù… ÙØ±Ø¹ÙŠØ©)
            let evaluationCriteria = '-';
            
            if (template) {
              if (template.subPoints && Array.isArray(template.subPoints) && template.subPoints.length > 0) {
                evaluationCriteria = template.subPoints.map((point: any) => 
                  point.ar || point.nameAr || point.name || 'Ø¨Ù†Ø¯ ØºÙŠØ± Ù…Ø­Ø¯Ø¯'
                ).join(' | ');
              } else if (template.multiTasks && Array.isArray(template.multiTasks) && template.multiTasks.length > 0) {
                evaluationCriteria = template.multiTasks.map((multiTask: any) => 
                  multiTask.ar || multiTask.nameAr || multiTask.name || 'Ù…Ù‡Ù…Ø© Ù…ØªØ¹Ø¯Ø¯Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©'
                ).join(' | ');
              } else if (template.subTasks && Array.isArray(template.subTasks) && template.subTasks.length > 0) {
                evaluationCriteria = template.subTasks.map((subTask: any) => 
                  subTask.ar || subTask.nameAr || subTask.name || 'Ù…Ù‡Ù…Ø© ÙØ±Ø¹ÙŠØ© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©'
                ).join(' | ');
              } else if (template.category) {
                evaluationCriteria = template.category;
              }
            }
            
            const rowData = [
              isFirstTask ? evaluation.checklistDate : '', // Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
              isFirstTask ? evaluationTime : '', // Ø§Ù„ÙˆÙ‚Øª ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
              isFirstTask ? (location?.nameAr || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') : '', // Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
              isFirstTask ? (user?.fullName || user?.username || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') : '', // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
              isFirstTask ? (company?.nameAr || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') : '', // Ø§Ù„Ø´Ø±ÙƒØ© ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
              taskName, // Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
              evaluationCriteria, // Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ© (ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©)
              task.rating || '0',
              task.completed ? 'Ù†Ø¹Ù…' : 'Ù„Ø§',
              taskIndex === 0 ? (evaluation.evaluationNotes || '') : '' // Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
            ];

            rowData.forEach((data, colIndex) => {
              const cell = detailSheet.getCell(currentRow, colIndex + 1);
              cell.value = data;
              cell.alignment = { horizontal: 'center', vertical: 'middle' };
              cell.border = {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
              };

              // ØªÙ„ÙˆÙŠÙ† Ù…Ø´Ø±ÙˆØ· Ù„Ù„ØªÙ‚ÙŠÙŠÙ…
              if (colIndex === 7 && task.rating) { // Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
                const rating = parseFloat(task.rating);
                if (rating >= 4) {
                  cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'C6EFCE' } };
                } else if (rating >= 3) {
                  cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEB9C' } };
                } else if (rating > 0) {
                  cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFC7CE' } };
                }
              }

              // ØªÙ„ÙˆÙŠÙ† Ù…Ø´Ø±ÙˆØ· Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„
              if (colIndex === 8) { // Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„
                if (task.completed) {
                  cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'C6EFCE' } };
                } else {
                  cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFC7CE' } };
                }
              }
            });
            currentRow++;
          }
        });
      }
    }

    // ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
    detailSheet.columns = [
      { width: 15 }, // Ø§Ù„ØªØ§Ø±ÙŠØ®
      { width: 12 }, // ÙˆÙ‚Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
      { width: 25 }, // Ø§Ù„Ù…ÙˆÙ‚Ø¹
      { width: 20 }, // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      { width: 20 }, // Ø§Ù„Ø´Ø±ÙƒØ©
      { width: 30 }, // Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
      { width: 35 }, // Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ©
      { width: 10 }, // Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
      { width: 10 }, // Ù…ÙƒØªÙ…Ù„Ø©
      { width: 30 }  // Ù…Ù„Ø§Ø­Ø¸Ø§Øª
    ];

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
    res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
    res.setHeader('Content-Disposition', `attachment; filename="location_details_report_${new Date().toISOString().split('T')[0]}.xlsx"`);

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù
    await workbook.xlsx.write(res);
    res.end();

    console.log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­ - ${evaluationsData.length} ØªÙ‚ÙŠÙŠÙ…`);

  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹:', error);
    res.status(500).json({ 
      message: 'ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±',
      error: process.env.NODE_ENV === 'development' ? (error as Error).message : 'Ø®Ø·Ø£ Ø¯Ø§Ø®Ù„ÙŠ'
    });
  }
});

export default router;