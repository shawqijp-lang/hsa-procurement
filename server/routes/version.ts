import { Router } from 'express';
import fs from 'fs/promises';
import path from 'path';
import { getDatabaseEnvironmentInfo, verifyDataSafety } from '../db';

const router = Router();

// ูุนูููุงุช ุงูุฅุตุฏุงุฑ ุงูุญุงูู - ุณูุชู ุฏูุฌูุง ูุน package.json
function getVersionString(): string {
  const baseVersion = '6.28.0';
  // ๐ ุฅุถุงูุฉ ูุงุญูุฉ ุงูุจูุฆุฉ ููุชูููุฒ - ุญู ููุงุฆู ููุนุฒู
  const isDeployment = process.env.REPLIT_DEPLOYMENT === '1';
  if (!isDeployment) {
    return `${baseVersion}-dev`;
  }
  return baseVersion;
}

const VERSION_INFO = {
  version: getVersionString(), // ุฅุตุฏุงุฑ ูุตู ุงูุจูุฆุงุช - ูุตู ูุงูู ุจูู ุงูุชุทููุฑ ูุงูุฅูุชุงุฌ
  buildTime: new Date().toLocaleString('sv-SE', {
    timeZone: 'Asia/Riyadh'
  }),
  buildHash: generateBuildHash(),
  features: [
    'ุชุซุจูุช ุฃุตูู ุนูู Edge Mobile ูุชุทุจูู ูุณุชูู',
    'Service Worker ูุญุณูู ููุชูุงูู ูุน ูุชุทูุจุงุช Edge',
    'ุตูุญุฉ ูุถุน ุนุฏู ุงูุงุชุตุงู ูุญุณููุฉ ููููุงุชู ุงููุญูููุฉ',
    'ูุธุงู PWA ูุชูุงูู ูุน ุฃููููุงุช ููุญุฏุฉ',
    'ุฏุนู ูุงูู ููุชุดุบูู ุจุฏูู ุดุฑูุท ุงููุชุตูุญ',
    'ุญูุธ ููุงูุจ ุงูุชุดููู ุชููุงุฆูุงู ูู ุฐุงูุฑุฉ ุงููุงุชู',
    'ูุธุงู ุชุณุฌูู ุฏุฎูู ูุญูู ูุชูุฏู ูููุงูู ููุญุฐู',
    'ุนุฑุถ ุฃุณูุงุก ุงูุดุฑูุงุช ุจุงูุนุฑุจูุฉ ูุงูุฅูุฌููุฒูุฉ ูู ุงูููุฏุฑ ุงูุนููู'
  ],
  changelog: [
    'ุฅุตุฏุงุฑ ุฌุฏูุฏ 6.28.0 - ุชุญุณููุงุช ูุธุงู ุงููุดุชุฑูุงุช ุงููุฑูุฒูุฉ ููุงุฌูุฉ ุชุณุฌูู ุงูุฏุฎูู!',
    'ุฅุตูุงุญ ุตูุงุญูุงุช ุงููุดุชุฑูุงุช ุงููุฑูุฒูุฉ: ููุชุฑ ุงูุดุฑูุงุช ูููุฏูุฑ ุงูุนุงู ููุท',
    'ุชูุญูุฏ ููุทู ุงูุตูุงุญูุงุช ุจูู ุฌููุน ุงูุตูุญุงุช ูููุณุชุฎุฏููู',
    'ุชุบููุฑ ุฃููููุฉ ุงููุดุชุฑูุงุช ุงููุฑูุฒูุฉ ุฅูู ุณูุฉ ุงูุชุณูู ๐',
    'ุชุญุณูู ุฎูููุฉ ุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู ุฅูู ุงูููู ุงูุฃุจูุถ ุงูููู',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.27.0 - ุชุญููู ูุธุงู ุนุฑุถ ุฃุณูุงุก ุงูุดุฑูุงุช ุฅูู ูุธุงู ุฏููุงูููู ูุงูู ูุฅุตูุงุญ ูุงุฌูุฉ ุชุณุฌูู ุงูุฎุฑูุฌ!',
    'ุชุญููู ุงููุธุงู ูู hardcoded ุฅูู ูุธุงู ุฏููุงูููู ูุฌูุจ ุฃุณูุงุก ุงูุดุฑูุงุช ูู API ุชููุงุฆูุงู',
    'ุฅุถุงูุฉ ุดุฑูุฉ ุฌุฏูุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุนุฑุถ ุงุณููุง ุงูุฅูุฌููุฒู ููุฑุงู ุจุฏูู ุชุนุฏูู ุงูููุฏ',
    'ุฅุตูุงุญ ุฎูููุฉ ูุงูุฐุฉ ุชุณุฌูู ุงูุฎุฑูุฌ ูู ุดูุงูุฉ ุฅูู ุจูุถุงุก ูุงุถุญุฉ',
    'ุฏุนู ุชููุงุฆู ูุฌููุน ุงูุดุฑูุงุช ุงูุญุงููุฉ ูุงููุณุชูุจููุฉ ูู ุงูุชุฑููุณุฉ',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.26.0 - ุฅุถุงูุฉ RIIC ู YCD ููุงุฆูุฉ ุฃุณูุงุก ุงูุดุฑูุงุช ูู ุงูุชุฑููุณุฉ',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.23.0 - ุชุญุณูู ูุธุงู ุงูุชุตุฏูุฑ ูุน ุฅุตูุงุญ ูุฑุงุฌุน ุงููุฎุทุท ูุชูุญูุฏ ููุงุนุฏ ุงูุจูุงูุงุช!',
    'ุฅุตูุงุญ ูุฑุงุฌุน ุงููุฎุทุท ุงูุญุฑุฌุฉ ูู ูุธููุฉ ุชุตุฏูุฑ PDF',
    'ูุญุงุฐุงุฉ ูุฎุทุท ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุน ุชุตุญูุญ ุชุนูููุงุช ุงูุญููู',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.22.0 - ุฅุตุฏุงุฑ ุงููุดุฑ ูุน ูุธุงู ููุงุนุฏ ุจูุงูุงุช ูููุตูุฉ ููุฅูุชุงุฌ ูุงูุชุทููุฑ!',
    'ุชุญุณูู ูุธุงู ุงูุนุฒู ุงููุงูู ุจูู ุจูุฆุชู ุงูุชุทููุฑ ูุงูุฅูุชุงุฌ',
    'ุฅุนุฏุงุฏ ููุงุนุฏ ุจูุงูุงุช ูููุตูุฉ ูุถูุงู ุฃูุงู ูุญูุงูุฉ ุจูุงูุงุช ุงูุฅูุชุงุฌ',
    'ุชุทููุฑ ูุธุงู ุชุญุฏูุฏ ุงูุจูุฆุฉ ุงูุชููุงุฆู ูุน ุงูุญูุงูุฉ ุงูุดุงููุฉ',
    'ุชุญุณููุงุช ูู ุงุณุชูุฑุงุฑ ุงููุธุงู ูุญู ูุดุงูู ุงูุนุฒู ุจูู ุงูุจูุฆุงุช',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.21.0 - ุชุญุณูู ุฅุนุฏุงุฏุงุช ุงูุจูุฆุฉ ููุธุงู ุฃุฑูุงู ุงูุฅุตุฏุงุฑ ุงูููุญุฏ!',
    'ุชุฃููุฏ ููุงุฆู: ุงูุจูุงูุงุช ุงูุฒูููุฉ (evaluationTime, evaluationDateTime, evaluationTimestamp) ุชูุฑุณู ูุชูุญูุธ ุจูุฌุงุญ',
    'ุฅุตูุงุญ ุดุงูู ูููู ุงูุจูุงูุงุช ูู ุงููุชุตูุญ ููุฎุงุฏู ูุน ูุฑุงูุจุฉ ุฏูููุฉ ููุนูููุฉ',
    'ุงููุฌุงุญ ุงููุงูู: ุงูุฃููุงุช ุชุธูุฑ ุงูุขู ูู ุชูุงุฑูุฑ Excel ูุน ุงูุชูุณูู ุงููุทููุจ',
    'ูุธุงู ูุฑุงูุจุฉ ูุชูุฏู ููุชุฃูุฏ ูู ุตุญุฉ ุฅุฑุณุงู ุงูุจูุงูุงุช ุงูุฒูููุฉ ูู ูู ุชูููู',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.20.0 - ุชุญุณูู ุงููุฒุงููุฉ ุงูุชููุงุฆูุฉ ูููุณุชุฎุฏููู ุงูุนุงุฏููู',
    'ุชู ุฅุถุงูุฉ ุงูููุช ุงููุนูู ููุชูููู ูู ุฌุฏุงูู ุฃูุฑุงู ุงูููุงูุน ุงูุชูุตูููุฉ',
    'ุงูููุช ูุธูุฑ ูุน ุงูุชุงุฑูุฎ ูู ุงูุชูุณูู: ุชุงุฑูุฎ - ููุช',
    'ุชู ุฅุถุงูุฉ ุงูููุช ุฃูุถุงู ูู ุนูุงููู ุงูุชููููุงุช ุงูุชูุตูููุฉ',
    'ูุตุฏุฑ ุงูููุช: ุงููุธุงู ุงูููุญุฏ unifiedEvaluations (evaluationTime ู evaluationDateTime)',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.20.5 - ุฅุฒุงูุฉ ุงูููุช ููุงุฆูุงู ูู ุชูุงุฑูุฑ Excel ุจูุงุกู ุนูู ุทูุจ ุงููุณุชุฎุฏู',
    'ุชูุช ุฅุฒุงูุฉ ุนููุฏ "ุงูููุช" ูู ุฑุคูุณ ุฌุฏุงูู Excel',
    'ุชูุช ุฅุฒุงูุฉ ุงูููุช ูู ุงูุจูุงูุงุช ุงููุนุฑูุถุฉ ูู ุงูุฌุฏุงูู',
    'ุชูุช ุฅุฒุงูุฉ ุงูููุช ูู ุนูุงููู ุงูุชููููุงุช',
    'ุงูุขู ุงูุชูุงุฑูุฑ ุชุนุฑุถ ุงูุชุงุฑูุฎ ููุท ุจุฏูู ุงูููุช',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.20.4 - ุฅุตูุงุญ ูุตุฏุฑ ุงูุจูุงูุงุช ูุชูุงุฑูุฑ Excel - ุงุณุชุฎุฏุงู ุงููุธุงู ุงูููุญุฏ',
    'ุชู ุชุญููู ูุฑุงุกุฉ ุงูุจูุงูุงุช ูู dailyChecklists ุงููุงุฑุบ ุฅูู unifiedEvaluations ุงููุนูู',
    'ุงูุขู ุณูุธูุฑ ุงูููุช ุงููุนูู ููุชููููุงุช ูู ุชูุงุฑูุฑ Excel ุจุฏูุงู ูู "ุบูุฑ ูุญุฏุฏ"',
    'ุฅุตูุงุญ ุดุงูู ููุจูุงูุงุช ุงููุณุชุฑุฌุนุฉ ูุงูุชูุณูู ุงูุตุญูุญ ูู unifiedEvaluations',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.20.3 - ุญุฐู ุงูููุช ุงููููู ููุงุฆูุงู ูุฅุนุงุฏุฉ ูุชุงุจุชู ูู ุงููุตุฏุฑ ุงูุตุญูุญ',
    'ุญุฐู ุฌููุน ุงุณุชุฎุฏุงูุงุช evaluationDate.toLocaleTimeString() ุงูููููุฉ',
    'ุงุณุชุฎุฏุงู evaluationTime ู evaluationDateTime ุงููุนูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ููุท',
    'ุนุฑุถ "ุบูุฑ ูุญุฏุฏ" ุนูุฏ ุนุฏู ูุฌูุฏ ููุช ูุนูู ุจุฏูุงู ูู ุงูููุช ุงููุฒูู',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.20.2 - ุฅุตูุงุญ ุดุงูู ููููุช ุงููุนูู ูู ุฌููุน ุชูุงุฑูุฑ Excel',
    'ุฅุตูุงุญ ุงูููู ุงูุตุญูุญ server/routes.ts ุจุฏูุงู ูู excel-reports-new.ts',
    'ุชุทุจูู ุงูููุช ุงููุนูู ููุชูููู ูู ุฌููุน ุฃูุฑุงู Excel ุจุชูููุช ุงูุฑูุงุถ',
    'ุฅุตูุงุญ ููุช ุงูุชูููู ูู generateEnhancedPDFReport.ts ุฃูุถุงู',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.20.1 - ุฅุตูุงุญ ุนุฑุถ ุงูููุช ุงููุนูู ูู ุชูุงุฑูุฑ Excel ุงูุงุญุชุฑุงููุฉ',
    'ุงุณุชุจุฏุงู ุงูููุช ุงููููู ุจุงูููุช ุงููุนูู ููุชูููู ูู ุฌููุน ุฎุงูุงุช ุชูุฑูุฑ Excel',
    'ุถูุงู ุงุณุชุฎุฏุงู ุชูููุช ุงูุฑูุงุถ (Asia/Riyadh) ูู ุฌููุน ุนูููุงุช ุชูุณูู ุงูุชูุงุฑูุฎ ูุงูุฃููุงุช',
    'ุชุญุณูู ุฏูุฉ ุงูุจูุงูุงุช ุงูุฒูููุฉ ูู ุชูุงุฑูุฑ Excel ุงูููููุฉ',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.20.0 - ุฅุตูุงุญ ุงููุฒุงููุฉ ุงูุชููุงุฆูุฉ ูููุณุชุฎุฏู ุงูุนุงุฏู',
    'ุฅุถุงูุฉ ุงููุฒุงููุฉ ุงูุชููุงุฆูุฉ ูููุญุฉ ุงูุชุญูู ุงูุนุงูุฉ ูุญู ูุดููุฉ ุงููุณุชุฎุฏู ุงูุนุงุฏู',
    'ุชูุนูู useUnifiedEvaluation ูุน autoSync ูู ููุญุฉ ุงูุชุญูู ุงูุฑุฆูุณูุฉ',
    'ุฅุตูุงุญ ูุดููุฉ ุนุฏู ูุฒุงููุฉ ุงูุชููููุงุช ุงููุญููุธุฉ ูุญููุงู ูููุณุชุฎุฏู ุงูุนุงุฏู',
    'ุชุญุณูู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู ุงูุนุงุฏู ูุน ูุฒุงููุฉ ุชููุงุฆูุฉ ุดุงููุฉ',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.19.0 - ุฅุตูุงุญ ูุงูู ููุงุนุฏุฉ ุงูุจูุงูุงุช ูุชุญุณูู ูุธุงู ุงููุฒุงููุฉ',
    'ุฅุถุงูุฉ ุงูุฃุนูุฏุฉ ุงูููููุฏุฉ (evaluation_time, evaluation_date_time, evaluation_timestamp) ูุฌุฏูู daily_checklists',
    'ุชุญุณูู ุขููุฉ ูุดู ุงูุชููููุงุช ุงููุญููุฉ ุบูุฑ ุงููุชุฒุงููุฉ ูุน ุฏุนู ูุนุงููุฑ ุจุญุซ ูุญุณูุฉ',
    'ุฅุตูุงุญ ุฎุทุฃ "column evaluation_time does not exist" ููุงุฆูุงู',
    'ุชุทููุฑ ูุธุงู ูุดู ุฐูู ููุชููููุงุช ูุฏุนู ุฌููุน ุฃููุงุน ุงูุจูุงูุงุช ุงููุญููุฉ',
    'ุชุญุณูู ุฑุณุงุฆู ุงูุชุดุฎูุต ูุงููุฑุงูุจุฉ ูู ุงููุฒุงููุฉ ุงูุชููุงุฆูุฉ',
    'ุถูุงู ุงุณุชูุฑุงุฑ ุงููุธุงู ุงูููุญุฏ ููุชููููุงุช ูุน ุงูุชูุงุฑูุฑ',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.18.0 - ุฅุตูุงุญ ุดุงูู ูููุธุงู ุงูููุญุฏ ูุชุญุณููุงุช Excel ุงููุชูุฏูุฉ',
    'ุฅุตูุงุญ ูุงูู ูุงูุชุดุงู ุงูุชููููุงุช ุงููุญููุฉ ุงููุชุฒุงููุฉ ูู ุงููุธุงู ุงูููุญุฏ',
    'ุชุญุณูู ุฌููุฑู ูู ูุนุงูุฌุฉ ุจูุงูุงุช ุงูููุงู ูู ุชูุงุฑูุฑ Excel ุงูููููุฉ',
    'ุฏุนู ูุชุนุฏุฏ ุงูุญููู ููููุงู ูุงูุชููููุงุช ูู ุชุตุฏูุฑ Excel',
    'ุฅุตูุงุญ ุนุฑุถ ุนุฏุฏ ุงูููุงู ุงูููุชููุฉ ููุชูุณุท ุงูุชูููู ุจุฏูุฉ',
    'ุชุญุณูู ููุชุฑุฉ ูุจุญุซ ุงูุชููููุงุช ูุน ุงุณุชุจุนุงุฏ ุงูุจูุงูุงุช ุงููุคูุชุฉ',
    'ูุนุงูุฌุฉ ูุญุณูุฉ ูุฌููุน ุฃููุงุน ุงูููุงุญุธุงุช ูุงูุชุนูููุงุช ูู ุงูุชูุงุฑูุฑ',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.17.0 - ุฅุตูุงุญ ูุธุงู ุงูุชูุงุฑูุฑ ุงููุฌูู ูุฏุนู ุงูุจูุงูุงุช ุงููุญููุฉ ูุงูุฎุงุฏู',
    'ุฅุนุงุฏุฉ ุฑุจุท ุงูุชูุงุฑูุฑ ุจูุธุงู HybridDataAccess ููุฌูุน ุจูู IndexedDB ูุงูุฎุงุฏู',
    'ุฅุตูุงุญ ูุดููุฉ ุนุฏู ุธููุฑ ุงูุชููููุงุช ุงููุญููุฉ ูู ุงูุชูุงุฑูุฑ',
    'ุชุญุณูู ุขููุฉ ุฌูุจ ุงูุจูุงูุงุช ูู ุงููุตุฏุฑูู ูุน ุฅุฒุงูุฉ ุงูุชูุฑุงุฑ',
    'ุฅุถุงูุฉ ูุธุงู ุชุฑุงุฌุน ุฐูู ูููุธุงู ุงูุชูููุฏู ุนูุฏ ูุดู ุงููุธุงู ุงููุฌูู',
    'ุชุญุณูู ุฑุณุงุฆู ุงูุชุดุฎูุต ูุงููุฑุงูุจุฉ ูุฌูุจ ุงูุจูุงูุงุช',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.16.0 - ุชูุธูู ุงููุธุงู ูุฅุฒุงูุฉ ุฑููุฒ ุงูุชุดุฎูุต ุงูุฒุงุฆุฏุฉ',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.15.0 - ุชุญุฏูุซ ููู ููุงุด ุงููุชุตูุญ ูุฅุฒุงูุฉ ุงูุจูุงูุงุช ุงููุฏููุฉ',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.14.0 - ุชุญุณููุงุช ูุชูุฏูุฉ ูู ุงููุธุงู ุงูููุญุฏ',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.13.0 - ุฅุฒุงูุฉ ุงูุดุงุดุฉ ุงููุญููุฉ ุงููููุตูุฉ ูุชูุญูุฏ ุชุฌุฑุจุฉ ุชุณุฌูู ุงูุฏุฎูู',
    'ุฅุฒุงูุฉ ูููู LocalLoginScreen ุงููููุตู ูุชูุญูุฏ ูุงูู ุงููุธุงุฆู ูู ุงูุดุงุดุฉ ุงูุฑุฆูุณูุฉ',
    'ุชุญุฏูุซ ุฌููุน ุงููุตูุต ูู "HSA EVALUATE" ุฅูู "ูุธุงู ุฅุฏุงุฑุฉ ุจูุฆุฉ ุงูุนูู" ููุชูุญูุฏ',
    'ุฅุตูุงุญ ูุดููุฉ ุงูุชุถุงุฑุจ ุจูู ูุงุฌูุงุช ูุฎุชููุฉ ูุชูุญูุฏ ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู',
    'ุชุญุณูู ูุงุด ุงููุชุตูุญ ูุถูุงู ุนุฑุถ ุงููุตูุต ุงูุฌุฏูุฏุฉ ููุฑุงู',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.12.0 - ุญูุงูุฉ ุดุงููุฉ ูู ุฃุฎุทุงุก IndexedDB ูู ุจูุฆุฉ ุงูุฅูุชุงุฌ',
    'ุฅุตูุงุญ ูุดููุฉ ุนุฑุถ ุฑุณุงุฆู ุงูุฎุทุฃ ุนูุฏ ุงุณุชุฑุฌุงุน ุงูุจูุงูุงุช ูู ุงูุจูุฆุงุช ุงูุฌุฏูุฏุฉ',
    'ุชุญุณูู ุฑุณุงุฆู ุงููุธุงู ูุชููู ูุฏูุฉ: "ูุฐุง ุทุจูุนู ุนูุฏ ุฃูู ุงุณุชุฎุฏุงู"',
    'ุญูุงูุฉ ูุญุณูุฉ ููุงูุฉ ุนูููุงุช ูุฑุงุกุฉ IndexedDB ูุน ูุนุงูุฌุฉ ุชุฏุฑูุฌูุฉ ููุฃุฎุทุงุก',
    'ุชุญุณูู ุงุณุชูุฑุงุฑ ุงููุธุงู ูู ุจูุฆุฉ ุงูุฅูุชุงุฌ ูุน ุฅุฒุงูุฉ ุงูุฑุณุงุฆู ุงููุถููุฉ',
    'ุชุนุฒูุฒ ููุฉ ุงููุธุงู ููุชุนุงูู ูุน ุงูุจูุงูุงุช ุงูููููุฏุฉ ุฃู ุงูุชุงููุฉ',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.11.0 - ูุธุงู ูุญุณู ููุญูุธ ุงูุชุชุงุจุนู ููููุงูุน ูุงูููุงูุจ',
    'ุชุทููุฑ ูุธุงู ููุญุฏ ูุญูุธ ุงูููุงูุน ูุน ููุงูุจูุง ุจุงูุชุณูุณู ุงูุฐูู',
    'ุฅุถุงูุฉ ูุญุต ูููุฉ ุงููุณุชุฎุฏู ููุณุญ ุงูุจูุงูุงุช ุนูุฏ ุชุบููุฑ ุงููุณุชุฎุฏู/ุงูุดุฑูุฉ',
    'ุชุญุณูู ุนูููุฉ ุงูุญูุธ ูุชุนูู ููุท ูู ูุถุน ุงูุงุชุตุงู ูุชุชุฎุทู ูุถุน ุนุฏู ุงูุงุชุตุงู',
    'ุฅุฒุงูุฉ ุงูุงุฒุฏูุงุฌูุฉ ูู ุฃูุธูุฉ ุญูุธ ุงูููุงูุจ ูุงูุงุนุชูุงุฏ ุนูู ูุธุงู ูุงุญุฏ ูุญุณู',
    'ุชุญุณููุงุช ูู ุงูุฃุฏุงุก ูุงูููุงุกุฉ ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู ูุชุญููู ุงูุจูุงูุงุช',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.10.0 - ุฅุตุฏุงุฑ ุงููุดุฑ ูุน ุฅุฒุงูุฉ ุฒุฑ ุงูุชุญุฏูุซ ูุชุญุณููุงุช ุงููุงุฌูุฉ',
    'ุฅุฒุงูุฉ ุฒุฑ ุงูุชุญุฏูุซ ูู ุงูุดุฑูุท ุงูุฃุฒุฑู ููุงุฆูุงู ููุฏูุณูุชูุจ ูุงูููุจุงูู',
    'ุฅุตูุงุญ ูุดููุฉ ุตูุงุญูุงุช analytics_viewer ูุนุฑุถ ุชุจููุจูู ููุท',
    'ุชุญุฏูุซ ูุธุงู ุงูุตูุงุญูุงุช ุงููุญูู ูุฅุตูุงุญ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ',
    'ุชุญุณููุงุช ูู ุงูุฃุฏุงุก ูุงูุงุณุชูุฑุงุฑ ุงูุนุงู ูููุธุงู',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.9.0 - ุฅุตุฏุงุฑ ุงูุฅูุชุงุฌ ูุน ุจูุงูุงุช ูุญุฏุซุฉ ูู ุงูุฅูุชุงุฌ',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.8.1 - ูุธุงู database schemas ูููุตูุฉ ููุนุฒู ุงููุงูู',
    'ุชุทุจูู schema ุชููุงุฆู: development ููุชุทููุฑ ู production ููุฅูุชุงุฌ',
    'ุถุจุท search_path ุชููุงุฆูุงู ุนูุฏ ูู ุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช',
    'ุฅูุดุงุก ูุธุงู executeWithSchema ููุถูุงู ุงููุทูู ููุนุฒู',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.8.0 - ุญู ููุงุฆู ูุญุงุณู ููุดููุฉ ุงูุนุฒู ุจูู ุงูุจูุฆุงุช',
    'ุงุณุชุฎุฏุงู ููุงุนุฏ ุจูุงูุงุช ูููุตูุฉ ุชูุงูุงู ููุชุทููุฑ ูุงูุฅูุชุงุฌ',
    'ุฅุฒุงูุฉ ุงูุงุนุชูุงุฏ ุนูู search_path ูุฅูุดุงุก ุนุฒู ุญูููู',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.7.0 - ุฅุตูุงุญ ููุงุฆู ููุดููุฉ ุชุฏุงุฎู ุงูุจูุฆุงุช ุนูุฏ ุงููุดุฑ',
    'ุงุณุชุฎุฏุงู REPLIT_DEPLOYMENT ุจุฏูุงู ูู REPLIT_DEV_DOMAIN ูููุดู ุงูุตุญูุญ',
    'ุญูุงูุฉ ูุทููุฉ ููุฅูุชุงุฌ ูู ุชุฃุซูุฑ ุชุนุฏููุงุช ุงูุชุทููุฑ',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.6.0 - ูุธุงู ูุตู ุงูุจูุฆุงุช ุงูููุชูู ูุน ูุฒุงููุฉ ูุฏููุฉ',
    'ูุตู ูุงูู ูููุงุฆู ุจูู ุจูุฆุฉ ุงูุชุทููุฑ ูุงูุฅูุชุงุฌ',
    'ูุธุงู ูุฒุงููุฉ ูุฏููุฉ ุฐููุฉ ูู ุงูุฅูุชุงุฌ ููุชุทููุฑ',
    'ุญูุงูุฉ ูุทููุฉ ูุจูุงูุงุช ุงูุฅูุชุงุฌ ูู ุชุฃุซูุฑ ุงูุชุทููุฑ',
    'ุฅุถุงูุฉ ูุงุญูุฉ -dev ูุฑูู ุงูุฅุตุฏุงุฑ ูู ุจูุฆุฉ ุงูุชุทููุฑ',
    'ูุธุงู ูุฎุทุทุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููููุตูุฉ (production/development schema)',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.5.0 - ูุตู ูุงูู ุจูู ุจูุฆุฉ ุงูุชุทููุฑ ูุงูุฅูุชุงุฌ',
    'ุงุณุชุฎุฏุงู REPLIT_DEPLOYMENT ูููุดู ุงูุตุญูุญ ุนู ุจูุฆุฉ ุงูุฅูุชุงุฌ',
    'ูุตู ููุงุฆู ุจูู ููุงุนุฏ ุงูุจูุงูุงุช: DATABASE_URL ููุชุทููุฑ ู DATABASE_URL_PROD ููุฅูุชุงุฌ',
    'ุงุฎุชุจุงุฑุงุช ุดุงููุฉ ูุถูุงู ุนุฏู ุชุฏุงุฎู ุงูุจูุงูุงุช ุจูู ุงูุจูุฆุชูู',
    'ุฅุถุงูุฉ ุชุณุฌููุงุช ุชุดุฎูุตูุฉ ููุฑุงูุจุฉ ุงูุจูุฆุฉ ุงููุดุทุฉ',
    'ุญู ูุดููุฉ ุงุณุชุฎุฏุงู ููุณ ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู ููุง ุงูุจูุฆุชูู ููุงุฆูุงู',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.4.1 - ุฅุตูุงุญ ูุดุงูู ุงููุตุงุฏูุฉ ูู ุงูุชูุงุฑูุฑ ุงูุฐููุฉ',
    'ุฅุตูุงุญ ุฎุทุฃ "jwt malformed" ูู ุงูุชูุงุฑูุฑ ุงูุฐููุฉ',
    'ุชุญุณูู ุขููุฉ ุงุณุชุฑุฌุงุน ุงูุชููู ูู IndexedDB',
    'ุชุทุจูู ููุณ ุขููุฉ ุงูุชููู ุงููุงุฌุญุฉ ูู ุชุตุฏูุฑ Excel ุนูู ุงูุชูุงุฑูุฑ ุงูุฐููุฉ',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.4.0 - ุชุญุณููุงุช PWA ููุชุซุจูุช ุงูุฃุตูู ุนูู Edge Mobile',
    'ุฅุตูุงุญ Service Worker ููุชูุงูู ูุน ูุชุทูุจุงุช Edge Mobile',
    'ุชูุธูู ูููุงุช HTML ูุชูุญูุฏ ูุณุงุฑุงุช ุงูุฃููููุงุช',
    'ุชุญุณูู ุตูุญุฉ ูุถุน ุนุฏู ุงูุงุชุตุงู ููููุงุชู ุงููุญูููุฉ',
    'ุฏุนู ูุงูู ููุชุซุจูุช ูุชุทุจูู ุฃุตูู ุนูู Edge',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.3.0 - ุญูุธ ููุงูุจ ุงูุชุดููู ูู ุฐุงูุฑุฉ ุงููุงุชู + ุชุญุณููุงุช ุงููุธุงู ุงูููุญุฏ',
    'ุฅุถุงูุฉ ุญูุธ ููุงูุจ ุงูุชุดููู ูู ููุณ ูุธุงู ุชุฎุฒูู ุงูููุงูุน',
    'ุชุญุฏูุซ ููุฑู ูุฐุงูุฑุฉ ุงููุงุชู ุนูุฏ ุชุบููุฑ ุฃู ูุงูุจ',
    'ุชุญุณูู ุฃุฏุงุก ุงููุธุงู ูู ูุถุน ุนุฏู ุงูุงุชุตุงู',
    'ุฏุนู ุงุณุชุฑุฌุงุน ุงูููุงูุจ ูู ุฐุงูุฑุฉ ุงููุงุชู ุนูุฏ ูุดู API',
    'ุชุญุณูู ุขููุฉ ุงูุญูุธ ุงูุชููุงุฆู ููุจูุงูุงุช ุงูุญูููุฉ',
    'ุฏูุฌ ูุงูู ูุน ุงููุธุงู ุงูููุญุฏ ูููุตุงุฏูุฉ ูุงูุชุฎุฒูู',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.1.1 - ุชุญุณูู ูุธุงู ุงูุจุญุซ ูู IndexedDB ุนูุฏ ุจุฏุก ุงูุชุทุจูู',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.1.0 - ุญู ูุดููุฉ ุนุฒู ุงูุจูุงูุงุช ุจูู ุงููุณุชุฎุฏููู ููุงุฆูุงู',
    'ุฅุถุงูุฉ ูุนุฑู ุงููุณุชุฎุฏู ุฅูู React Query queryKey ูุชุฌูุจ ุชุฏุงุฎู ุงููุงุด',
    'ุชุญุณูู ููุทู ูุญุต ูููุฉ ุงููุณุชุฎุฏู ูุจู ุนุฑุถ ุงูุจูุงูุงุช ุงููุญููุธุฉ',
    'ุฅุตูุงุญ ูุดููุฉ ุนุฑุถ ุจูุงูุงุช ุงููุณุชุฎุฏู ุงูุณุงุจู ุนูุฏ ุงูุชุจุฏูู',
    'ุชุนุฒูุฒ ุฃูุงู ุงููุธุงู ูุน ูุตู ูุงูู ููุจูุงูุงุช ุจูู ุงููุณุชุฎุฏููู',
    'ุฅุตุฏุงุฑ ุณุงุจู 6.0.0 - ุชุญุณููุงุช ุดุงููุฉ ููุธุงู ูุญุณู',
    'ุชุทููุฑ ุงููุธุงู ุจุดูู ูุงูู ูุน ุชุญุณููุงุช ูู ุงูุฃุฏุงุก ูุงูุงุณุชูุฑุงุฑ',
    'ูุธุงู ุชุญุฏูุซุงุช ุฐูู ููุชุทูุฑ ูููุณุชูุจู',
    'ุชุญุณููุงุช ุฃูููุฉ ูุชูููุฉ ูุชูุฏูุฉ',
    'ูุงุฌูุฉ ูุณุชุฎุฏู ูุญุณูุฉ ููุชุทูุฑุฉ',
    'ุนุฑุถ ุฃุณูุงุก ุงูุดุฑูุงุช ุงูุซูุงุฆูุฉ ุงููุบุฉ - ุงูุฅุตุฏุงุฑ ุงูุณุงุจู 3.3.0',
    'ุฅุถุงูุฉ ุฃุณูุงุก ุงูุดุฑูุงุช ุจุงูุฅูุฌููุฒูุฉ ูู ุงูููุฏุฑ ุงูุนููู',
    'ุชุญุณูู ุงูุชุตููู ูุน ุฎุท ูุฃููุงู ุฃูููุฉ ูููุต ุงูุฅูุฌููุฒู',
    'ูุญุงุฐุงุฉ ูุซุงููุฉ ูููุตูู ุงูุนุฑุจู ูุงูุฅูุฌููุฒู ูุน ูุงุตู ุฐูุจู',
    'ุชุทุจูู ุฃููุงู ูููุฉ HSA ุงููุชุฏุฑุฌุฉ ูููุต ุงูุซุงููู',
    'ูุธุงู ุชุณุฌูู ุฏุฎูู ูุญูู ูุชูุฏู - ุงูุฅุตุฏุงุฑ ุงูุณุงุจู 3.2.0',
    'ุฅุถุงูุฉ Service Worker ููุงูู ููุญุฐู ูุน cache ุฏุงุฆู',
    'ุชุทููุฑ ุตูุญุฉ offline.html ุดุงููุฉ ูุน ูููุฐุฌ ุชุณุฌูู ูุงูู',
    'ุชุญุณูู ูุธุงู IndexedDB ูุน ุชุดููุฑ ูุญูุงูุฉ ูุชุนุฏุฏุฉ ุงููุณุชููุงุช',
    'ุขููุฉ ุงุณุชุฑุฌุงุน ุฐููุฉ ููุจูุงูุงุช ุชุนูู ุญุชู ุจุนุฏ ุฅุบูุงู ุงูุชุทุจูู'
  ]
};

function generateBuildHash(): string {
  // ุงุณุชุฎุฏุงู ุงูุชูููุช ุงููุญูู ููุฌูุงุฒ ูู ุฅูุดุงุก ุงููุงุด
  const localTimestamp = new Date().toLocaleString('sv-SE', {
    timeZone: 'Asia/Riyadh'
  }).replace(/[- :]/g, '');
  const random = Math.random().toString(36).substring(2);
  return `${localTimestamp}-${random}`;
}

// GET /api/version - ุงูุญุตูู ุนูู ูุนูููุงุช ุงูุฅุตุฏุงุฑ
router.get('/', async (req, res) => {
  try {
    console.log('๐ Version API - Fetching version information');

    // ูุญุงููุฉ ูุฑุงุกุฉ ูุนูููุงุช ุงูุฅุตุฏุงุฑ ูู ููู package.json
    let packageInfo;
    try {
      const packagePath = path.join(process.cwd(), 'package.json');
      const packageContent = await fs.readFile(packagePath, 'utf-8');
      packageInfo = JSON.parse(packageContent);
    } catch (error) {
      console.log('โ๏ธ Could not read package.json, using default version info');
    }

    // ๐ก๏ธ ุงูุญุตูู ุนูู ูุนูููุงุช ุงูุจูุฆุฉ ูุงูุฃูุงู
    const environmentInfo = getDatabaseEnvironmentInfo();
    const safetyInfo = await verifyDataSafety();

    // ุฏูุฌ ูุนูููุงุช ุงูุฅุตุฏุงุฑ - ุฅุนุทุงุก ุฃููููุฉ ููุฅุตุฏุงุฑ ุงููุญุฏุฏ ูู VERSION_INFO
    const versionResponse = {
      ...VERSION_INFO,
      version: VERSION_INFO.version, // ุงุณุชุฎุฏุงู ุงูุฅุตุฏุงุฑ ุงููุญุฏุฏ ูู VERSION_INFO ูุจุงุดุฑุฉ
      name: packageInfo?.name || 'HSA Work Environment Management System',
      description: packageInfo?.description || 'ูุธุงู ุจูุฆุฉ ุงูุนูู ุงููุชูุฏู',
      serverTime: new Date().toLocaleString('sv-SE', {
        timeZone: 'Asia/Riyadh'
      }),
      uptime: process.uptime(),
      nodeVersion: process.version,
      environment: process.env.NODE_ENV || 'development',
      // ๐ก๏ธ ูุนูููุงุช ุงูุจูุฆุฉ ูุงูุฃูุงู ุงูุฌุฏูุฏุฉ
      environmentSecurity: {
        currentEnvironment: environmentInfo.environment,
        databaseType: environmentInfo.databaseType,
        safetyLevel: environmentInfo.safetyLevel,
        dataIsolation: environmentInfo.dataIsolation,
        safetyVerification: safetyInfo,
        isProductionProtected: environmentInfo.isProduction,
        securityFeatures: [
          'ูุตู ูุงูู ูููุงุนุฏ ุงูุจูุงูุงุช',
          'ุญูุงูุฉ ุจูุงูุงุช ุงูุฅูุชุงุฌ',
          'ุนุฒู ุจูุงูุงุช ุงูุชุทููุฑ',
          'ูุฑุงูุจุฉ ุงูุจูุฆุฉ ุงูุชููุงุฆูุฉ',
          'ูุธุงู ุฃูุงู ูุชุนุฏุฏ ุงูุทุจูุงุช'
        ]
      }
    };

    console.log(`๐ Version API - Returning version: ${versionResponse.version}`);
    
    res.json(versionResponse);

  } catch (error) {
    console.error('โ Version API Error:', error);
    res.status(500).json({
      error: 'Failed to fetch version information',
      message: 'ุฎุทุฃ ูู ุงูุญุตูู ุนูู ูุนูููุงุช ุงูุฅุตุฏุงุฑ'
    });
  }
});

// GET /api/version/check - ูุญุต ุงูุชุญุฏูุซุงุช ุงููุชุงุญุฉ
router.get('/check', async (req, res) => {
  try {
    const currentVersion = req.query.current as string;
    const currentHash = req.query.hash as string;

    console.log(`๐ Version Check - Current: ${currentVersion}, Hash: ${currentHash}`);

    // ููุงุฑูุฉ ุงูุฅุตุฏุงุฑุงุช
    const hasUpdate = currentVersion !== VERSION_INFO.version || 
                     currentHash !== VERSION_INFO.buildHash;

    const updateInfo = {
      hasUpdate,
      currentVersion,
      latestVersion: VERSION_INFO.version,
      currentHash,
      latestHash: VERSION_INFO.buildHash,
      isForced: isForceUpdate(currentVersion, VERSION_INFO.version),
      updateSize: calculateUpdateSize(),
      changelog: hasUpdate ? VERSION_INFO.changelog : [],
      releaseNotes: hasUpdate ? generateReleaseNotes(currentVersion, VERSION_INFO.version) : null
    };

    console.log(`๐ Version Check - Update available: ${hasUpdate}`);
    
    res.json(updateInfo);

  } catch (error) {
    console.error('โ Version Check Error:', error);
    res.status(500).json({
      error: 'Failed to check for updates',
      message: 'ุฎุทุฃ ูู ูุญุต ุงูุชุญุฏูุซุงุช'
    });
  }
});

// POST /api/version/report - ุชูุฑูุฑ ุชุทุจูู ุงูุชุญุฏูุซ
router.post('/report', async (req, res) => {
  try {
    const { 
      previousVersion, 
      newVersion, 
      updateTime, 
      success, 
      errorDetails 
    } = req.body;

    console.log(`๐ Update Report - ${previousVersion} โ ${newVersion}, Success: ${success}`);

    // ูููู ุญูุธ ุฅุญุตุงุฆูุงุช ุงูุชุญุฏูุซ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ููุง
    // ูุฃุบุฑุงุถ ุงููุฑุงูุจุฉ ูุงูุชุญููู

    if (success) {
      console.log('โ Update completed successfully');
    } else {
      console.error('โ Update failed:', errorDetails);
    }

    res.json({
      acknowledged: true,
      timestamp: new Date().toISOString(),
      message: success ? 'ุชู ุงูุฅุจูุงุบ ุนู ูุฌุงุญ ุงูุชุญุฏูุซ' : 'ุชู ุงูุฅุจูุงุบ ุนู ูุดู ุงูุชุญุฏูุซ'
    });

  } catch (error) {
    console.error('โ Update Report Error:', error);
    res.status(500).json({
      error: 'Failed to process update report',
      message: 'ุฎุทุฃ ูู ูุนุงูุฌุฉ ุชูุฑูุฑ ุงูุชุญุฏูุซ'
    });
  }
});

// ุชุญุฏูุฏ ุฅุฐุง ูุงู ุงูุชุญุฏูุซ ุฅุฌุจุงุฑู
function isForceUpdate(currentVersion: string, latestVersion: string): boolean {
  try {
    const current = parseVersion(currentVersion);
    const latest = parseVersion(latestVersion);

    // ุชุญุฏูุซ ุฅุฌุจุงุฑู ุฅุฐุง ุชุบูุฑ ุงูุฅุตุฏุงุฑ ุงูุฑุฆูุณู
    return latest.major > current.major;

  } catch (error) {
    // ูู ุญุงูุฉ ุฎุทุฃ ูู ุชุญููู ุงูุฅุตุฏุงุฑุ ูุนุชุจุฑ ุงูุชุญุฏูุซ ุบูุฑ ุฅุฌุจุงุฑู
    return false;
  }
}

// ุชุญููู ุฑูู ุงูุฅุตุฏุงุฑ
function parseVersion(version: string): { major: number; minor: number; patch: number } {
  const parts = version.split('.').map(Number);
  return {
    major: parts[0] || 0,
    minor: parts[1] || 0,
    patch: parts[2] || 0
  };
}

// ุญุณุงุจ ุญุฌู ุงูุชุญุฏูุซ ุงูุชูุฏูุฑู
function calculateUpdateSize(): string {
  // ุชูุฏูุฑ ุจุณูุท ูุญุฌู ุงูุชุญุฏูุซ
  const estimatedSizes = ['1.2 ููุฌุงุจุงูุช', '800 ููููุจุงูุช', '2.1 ููุฌุงุจุงูุช', '1.5 ููุฌุงุจุงูุช'];
  return estimatedSizes[Math.floor(Math.random() * estimatedSizes.length)];
}

// ุชูููุฏ ููุงุญุธุงุช ุงูุฅุตุฏุงุฑ
function generateReleaseNotes(fromVersion: string, toVersion: string): string {
  return `
ุชุญุฏูุซ ูู ุงูุฅุตุฏุงุฑ ${fromVersion} ุฅูู ${toVersion}

ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ:
โข ูุธุงู ุงูุชุญุฏูุซ ุงูุชููุงุฆู ุงูุฐูู
โข ุชุญุณููุงุช ูู ุงูุฃุฏุงุก ูุงูุงุณุชูุฑุงุฑ
โข ูุงุฌูุฉ ูุณุชุฎุฏู ูุญุณูุฉ
โข ุฅุตูุงุญุงุช ุฃูููุฉ ูููุฉ

ุงูุชุญุณููุงุช:
โข ุชุญุณูู ุณุฑุนุฉ ุงูุชุญููู
โข ุชุญุณูู ุฅุฏุงุฑุฉ ุฐุงูุฑุฉ ุงูุชุฎุฒูู
โข ุชุญุณูู ุชุฌุฑุจุฉ ุงูุนูู ุจุฏูู ุงูุชุฑูุช

ุงูุฅุตูุงุญุงุช:
โข ุฅุตูุงุญ ูุดุงูู ุงููุฒุงููุฉ
โข ุฅุตูุงุญ ูุดุงูู ุงููุณุฎ ุงูุงุญุชูุงุทู
โข ุฅุตูุงุญุงุช ุนุงูุฉ ููุงุณุชูุฑุงุฑ
  `.trim();
}

export default router;