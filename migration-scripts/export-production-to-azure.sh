#!/bin/bash

# ==========================================
# ุณูุฑูุจุช ุชุตุฏูุฑ ูุงุนุฏุฉ ุจูุงูุงุช ุงูุฅูุชุงุฌ
# ููููู ุฅูู Azure PostgreSQL
# ==========================================

echo "๐ ุจุฏุก ุชุตุฏูุฑ ูุงุนุฏุฉ ุจูุงูุงุช ุงูุฅูุชุงุฌ..."
echo "========================================"

# ุงูุชุญูู ูู ูุฌูุฏ DATABASE_URL_PROD
if [ -z "$DATABASE_URL_PROD" ]; then
    echo "โ ุฎุทุฃ: DATABASE_URL_PROD ุบูุฑ ููุฌูุฏ ูู ุงูุจูุฆุฉ"
    echo "ูุฑุฌู ุชุนููู ูุชุบูุฑ ุงูุจูุฆุฉ DATABASE_URL_PROD"
    exit 1
fi

# ุฅูุดุงุก ูุฌูุฏ ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ
BACKUP_DIR="azure-migration-backup"
mkdir -p $BACKUP_DIR

# ุงุณู ุงูููู ุจุงูุชุงุฑูุฎ ูุงูููุช
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_FILE="$BACKUP_DIR/production_export_$TIMESTAMP"

echo "๐ ูุฌูุฏ ุงููุณุฎ ุงูุงุญุชูุงุทู: $BACKUP_DIR"
echo "๐ ุงุณู ุงูููู: $BACKUP_FILE"
echo ""

# ==========================================
# ุงูุฎูุงุฑ 1: ุชุตุฏูุฑ Custom Format (ููุตู ุจู)
# ==========================================
echo "๐ฆ ุฌุงุฑู ุงูุชุตุฏูุฑ ุจุตูุบุฉ Custom Format..."
pg_dump "$DATABASE_URL_PROD" \
  --schema=production \
  --no-owner \
  --no-privileges \
  --format=custom \
  --file="${BACKUP_FILE}.dump"

if [ $? -eq 0 ]; then
    echo "โ ูุฌุญ ุงูุชุตุฏูุฑ Custom Format: ${BACKUP_FILE}.dump"
else
    echo "โ ูุดู ุงูุชุตุฏูุฑ Custom Format"
    exit 1
fi

# ==========================================
# ุงูุฎูุงุฑ 2: ุชุตุฏูุฑ SQL Format (ูููุฑุงุกุฉ)
# ==========================================
echo ""
echo "๐ ุฌุงุฑู ุงูุชุตุฏูุฑ ุจุตูุบุฉ SQL..."
pg_dump "$DATABASE_URL_PROD" \
  --schema=production \
  --no-owner \
  --no-privileges \
  > "${BACKUP_FILE}.sql"

if [ $? -eq 0 ]; then
    echo "โ ูุฌุญ ุงูุชุตุฏูุฑ SQL Format: ${BACKUP_FILE}.sql"
else
    echo "โ ูุดู ุงูุชุตุฏูุฑ SQL Format"
    exit 1
fi

# ==========================================
# ุฅุญุตุงุฆูุงุช ุงููููุงุช
# ==========================================
echo ""
echo "๐ ุฅุญุตุงุฆูุงุช ุงููููุงุช ุงูููุตุฏูุฑุฉ:"
echo "========================================"
ls -lh ${BACKUP_FILE}.*

# ==========================================
# ูุนูููุงุช ูููุฉ
# ==========================================
echo ""
echo "โ ุงูุชูู ุงูุชุตุฏูุฑ ุจูุฌุงุญ!"
echo ""
echo "๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ:"
echo "1. ุญููู ุงููููุงุช ูู: $BACKUP_DIR"
echo "2. ุฃูุดุฆ Azure PostgreSQL Server"
echo "3. ุงุณุชูุฑุฏ ุงูุจูุงูุงุช ุจุงุณุชุฎุฏุงู:"
echo "   pg_restore ุฃู psql"
echo ""
echo "๐ ููุงุญุธุฉ ุฃูููุฉ: ุงุญุฐู ุงููููุงุช ุจุนุฏ ุงูููู ุงููุงุฌุญ"
echo "========================================"
